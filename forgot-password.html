<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRBRNKNC97"></script>
    <script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-KRBRNKNC97');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password | PhillySports.com</title>
    <meta name="description" content="Reset your PhillySports.com password via email or SMS.">
    <meta name="robots" content="noindex, follow">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/mobile-menu.css">
    <style>
        :root {
            --eagles-green: #004C54;
            --phillies-red: #E81828;
            --sixers-blue: #006BB6;
            --flyers-orange: #F74902;
            --dark-bg: #faf9f6;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-muted: #888888;
            --header-bg: #faf9f6;
            --nav-text: #333333;
            --accent-color: #8b0000;
        }
        [data-theme="dark"] {
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --header-bg: #1a1a1a;
            --nav-text: #d0d0d0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        a { color: inherit; text-decoration: none; }

        .header { background: var(--header-bg); border-bottom: 1px solid var(--border-color); }
        .header-top { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem; max-width: 1400px; margin: 0 auto; }
        .header-logo { display: flex; align-items: center; gap: 0.5rem; }
        .header-logo img { width: 40px; height: 40px; border-radius: 6px; }
        .main-nav { background: var(--header-bg); border-bottom: 1px solid var(--border-color); }
        .nav-inner { display: flex; max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; align-items: center; }
        .nav-item { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; color: var(--nav-text); text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: color 0.2s; white-space: nowrap; text-decoration: none; }
        .nav-item:hover { color: var(--accent-color); }
        .nav-dropdown { position: relative; }
        .dropdown-trigger { display: flex; align-items: center; gap: 0.25rem; }
        .dropdown-arrow { font-size: 0.5rem; transition: transform 0.2s; }
        .dropdown-menu { position: absolute; top: 100%; left: 0; background: var(--header-bg); border: 1px solid var(--border-color); border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; z-index: 1000; }
        .nav-dropdown:hover .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .nav-dropdown:hover .dropdown-arrow { transform: rotate(180deg); }
        .dropdown-menu a { display: block; padding: 0.6rem 1rem; color: var(--nav-text); font-size: 0.8rem; font-weight: 500; text-decoration: none; transition: background 0.2s, color 0.2s; }
        .dropdown-menu a:hover { background: rgba(0,0,0,0.05); color: var(--accent-color); }

        .main-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }

        .auth-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 420px; padding: 2rem; }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--text-secondary); font-size: 0.9rem; }

        .method-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .method-btn { flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
        .method-btn:hover { border-color: var(--accent-color); }
        .method-btn.active { border-color: var(--accent-color); background: rgba(139,0,0,0.1); color: var(--accent-color); }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-group input { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: inherit; background: var(--card-bg); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--sixers-blue); box-shadow: 0 0 0 3px rgba(0,107,182,0.1); }
        .form-group input::placeholder { color: var(--text-muted); }

        .code-input-group { display: flex; gap: 0.5rem; justify-content: center; }
        .code-input { width: 50px; height: 60px; text-align: center; font-size: 1.5rem; font-weight: 700; border: 2px solid var(--border-color); border-radius: 8px; background: var(--card-bg); color: var(--text-primary); }
        .code-input:focus { outline: none; border-color: var(--accent-color); }

        .btn { width: 100%; padding: 0.875rem 1rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--phillies-red), var(--flyers-orange)); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--border-color); color: var(--text-primary); margin-top: 0.75rem; }
        .btn-secondary:hover { background: var(--text-muted); color: white; }

        .auth-footer { margin-top: 1.5rem; text-align: center; font-size: 0.9rem; color: var(--text-secondary); }
        .auth-footer a { color: var(--sixers-blue); font-weight: 600; }
        .auth-footer a:hover { text-decoration: underline; }

        .error-message { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .error-message.show { display: block; }

        .success-message { background: #dcfce7; border: 1px solid #bbf7d0; color: #16a34a; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .success-message.show { display: block; }

        .info-message { background: #dbeafe; border: 1px solid #bfdbfe; color: #1d4ed8; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; }

        .footer { padding: 1rem; background: var(--card-bg); border-top: 1px solid var(--border-color); text-align: center; }
        .footer-copy { color: var(--text-muted); font-size: 0.75rem; }

        .theme-toggle { background: none; border: 1px solid var(--border-color); border-radius: 20px; padding: 0.4rem 0.6rem; cursor: pointer; font-size: 1rem; line-height: 1; transition: all 0.2s; display: flex; align-items: center; gap: 0.25rem; }
        .theme-toggle:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .theme-toggle:hover { background: rgba(255,255,255,0.1); }
        .theme-toggle .theme-icon-light, .theme-toggle .theme-icon-dark { display: none; }
        .theme-toggle .theme-icon-light { display: inline; }
        [data-theme="dark"] .theme-toggle .theme-icon-light { display: none; }
        [data-theme="dark"] .theme-toggle .theme-icon-dark { display: inline; }

        .header-auth { display: flex; align-items: center; gap: 1rem; }
        .header-auth a { color: var(--nav-text); font-size: 0.85rem; font-weight: 600; }
        .header-auth a:hover { color: var(--accent-color); }

        .step { display: none; }
        .step.active { display: block; }

        .resend-link { text-align: center; margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted); }
        .resend-link a { color: var(--sixers-blue); cursor: pointer; }
        .resend-link a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .main-nav { display: none; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <a href="/" class="header-logo">
                <img src="/logo-weathered.png" alt="PhillySports.com">
            </a>
            <div class="header-auth">
                <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                    <span class="theme-icon-light">&#9790;</span>
                    <span class="theme-icon-dark">&#9728;</span>
                </button>
                <a href="/login.html">Login</a>
            </div>
        </div>
        <nav class="main-nav">
            <div class="nav-inner">
                <a href="/" class="nav-item">Home</a>
                <div class="nav-dropdown">
                    <span class="nav-item dropdown-trigger">Pro Teams <span class="dropdown-arrow">&#9660;</span></span>
                    <div class="dropdown-menu">
                        <a href="/eagles">Eagles</a>
                        <a href="/phillies">Phillies</a>
                        <a href="/sixers">76ers</a>
                        <a href="/flyers">Flyers</a>
                    </div>
                </div>
                <div class="nav-dropdown">
                    <span class="nav-item dropdown-trigger">College <span class="dropdown-arrow">&#9660;</span></span>
                    <div class="dropdown-menu">
                        <a href="/villanova">Villanova</a>
                        <a href="/penn">Penn</a>
                        <a href="/lasalle">La Salle</a>
                        <a href="/drexel">Drexel</a>
                        <a href="/stjosephs">St. Joseph's</a>
                        <a href="/temple">Temple</a>
                    </div>
                </div>
                <a href="/esports" class="nav-item">eSports</a>
                <a href="/youth" class="nav-item">Youth</a>
            </div>
        </nav>
    </header>

    <main class="main-container">
        <div class="auth-card">
            <!-- Step 1: Choose method and enter email/phone -->
            <div class="step active" id="step1">
                <div class="auth-header">
                    <h1>Forgot Password?</h1>
                    <p>Enter your email to receive a reset link</p>
                </div>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>

                <!-- SMS option disabled until Twilio upgraded
                <div class="method-toggle">
                    <button class="method-btn active" id="emailMethodBtn" onclick="setMethod('email')">Email Link</button>
                    <button class="method-btn" id="smsMethodBtn" onclick="setMethod('sms')">Text Code</button>
                </div>
                -->

                <form id="requestForm">
                    <div class="form-group" id="emailGroup">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" placeholder="Enter your email" required>
                    </div>

                    <div class="form-group" id="phoneGroup" style="display: none;">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" placeholder="(555) 555-5555">
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">Send Reset Link</button>
                </form>

                <div class="auth-footer">
                    <p>Remember your password? <a href="/login.html">Sign in</a></p>
                </div>
            </div>

            <!-- Step 2: Enter SMS code -->
            <div class="step" id="step2">
                <div class="auth-header">
                    <h1>Enter Code</h1>
                    <p>We sent a 6-digit code to your phone</p>
                </div>

                <div class="error-message" id="codeErrorMessage"></div>

                <form id="codeForm">
                    <div class="form-group">
                        <label>Verification Code</label>
                        <div class="code-input-group">
                            <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric" pattern="[0-9]">
                            <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric" pattern="[0-9]">
                            <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric" pattern="[0-9]">
                            <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric" pattern="[0-9]">
                            <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric" pattern="[0-9]">
                            <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric" pattern="[0-9]">
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="verifyBtn">Verify Code</button>
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                </form>

                <div class="resend-link">
                    <p>Didn't receive a code? <a onclick="resendCode()">Resend</a></p>
                </div>
            </div>

            <!-- Step 3: Email sent confirmation -->
            <div class="step" id="step3">
                <div class="auth-header">
                    <h1>Check Your Email</h1>
                    <p>We sent a password reset link to your email address</p>
                </div>

                <div class="info-message">
                    <p>Click the link in your email to reset your password. The link expires in 1 hour.</p>
                </div>

                <button class="btn btn-secondary" onclick="goToStep(1)">Try a different method</button>

                <div class="auth-footer">
                    <p>Remember your password? <a href="/login.html">Sign in</a></p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p class="footer-copy">&copy; 2025 PhillySports.com. All rights reserved.</p>
    </footer>

    <script>
        // Dark Mode Toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // State
        let currentMethod = 'email';
        let userId = null;

        function setMethod(method) {
            currentMethod = method;
            document.getElementById('emailMethodBtn').classList.toggle('active', method === 'email');
            document.getElementById('smsMethodBtn').classList.toggle('active', method === 'sms');
            document.getElementById('emailGroup').style.display = method === 'email' ? 'block' : 'none';
            document.getElementById('phoneGroup').style.display = method === 'sms' ? 'block' : 'none';
            document.getElementById('submitBtn').textContent = method === 'email' ? 'Send Reset Link' : 'Send Code';

            // Update required attributes
            document.getElementById('email').required = method === 'email';
            document.getElementById('phone').required = method === 'sms';
        }

        function goToStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
        }

        // Format phone number as user types
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);
            if (value.length >= 6) {
                value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            }
            e.target.value = value;
        });

        // Handle request form submission
        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const body = { method: currentMethod };
                if (currentMethod === 'email') {
                    body.email = document.getElementById('email').value;
                } else {
                    body.phone = document.getElementById('phone').value;
                }

                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Request failed');
                }

                if (currentMethod === 'sms') {
                    userId = data.userId;
                    goToStep(2);
                    document.querySelector('.code-input').focus();
                } else {
                    goToStep(3);
                }
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.add('show');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = currentMethod === 'email' ? 'Send Reset Link' : 'Send Code';
            }
        });

        // Code input handling
        const codeInputs = document.querySelectorAll('.code-input');
        codeInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (value && index < codeInputs.length - 1) {
                    codeInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    codeInputs[index - 1].focus();
                }
            });
            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);
                pastedData.split('').forEach((char, i) => {
                    if (codeInputs[i]) codeInputs[i].value = char;
                });
                if (pastedData.length === 6) {
                    document.getElementById('codeForm').dispatchEvent(new Event('submit'));
                }
            });
        });

        // Handle code verification
        document.getElementById('codeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const verifyBtn = document.getElementById('verifyBtn');
            const errorMessage = document.getElementById('codeErrorMessage');

            errorMessage.classList.remove('show');

            const code = Array.from(codeInputs).map(input => input.value).join('');
            if (code.length !== 6) {
                errorMessage.textContent = 'Please enter the complete 6-digit code';
                errorMessage.classList.add('show');
                return;
            }

            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';

            try {
                const response = await fetch('/api/auth/verify-reset-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, code })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Verification failed');
                }

                // Redirect to reset password page with token
                window.location.href = `/reset-password.html?token=${data.resetToken}`;
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.add('show');
                // Clear code inputs
                codeInputs.forEach(input => input.value = '');
                codeInputs[0].focus();
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify Code';
            }
        });

        async function resendCode() {
            const phone = document.getElementById('phone').value;
            try {
                await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ method: 'sms', phone })
                });
                alert('A new code has been sent to your phone.');
            } catch (error) {
                alert('Failed to resend code. Please try again.');
            }
        }
    </script>
    <script src="/js/mobile-menu.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRBRNKNC97"></script>
    <script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-KRBRNKNC97');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poker Table | PhillySports.com</title>
    <meta name="description" content="Play Texas Hold'em poker on PhillySports.com">
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        :root {
            --poker-green: #1a5c3a;
            --poker-felt: #35654d;
            --poker-felt-dark: #2a503d;
            --gold: #ffd700;
            --dark-bg: #1a1a1a;
            --card-bg: #2c2c2c;
            --border-color: #3a3a3a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --red: #e63946;
            --blue: #4a90d9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        html { height: -webkit-fill-available; }
        a { color: inherit; text-decoration: none; }
        button, a, input, select { touch-action: manipulation; }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .header-left { display: flex; align-items: center; gap: 1rem; }
        .header-left a { display: flex; align-items: center; gap: 0.5rem; }
        .header-left img { width: 32px; height: 32px; border-radius: 4px; }
        .header-left span { font-weight: 600; }
        .tournament-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.85rem;
        }
        .info-item { display: flex; flex-direction: column; align-items: center; }
        .info-label { color: var(--text-muted); font-size: 0.7rem; text-transform: uppercase; }
        .info-value { font-weight: 700; color: var(--gold); }
        .header-right { display: flex; align-items: center; gap: 1rem; }
        .coin-display {
            display: flex; align-items: center; gap: 0.35rem;
            background: rgba(255,215,0,0.15); padding: 0.35rem 0.75rem;
            border-radius: 20px; font-weight: 600; font-size: 0.85rem; color: #ffd700;
        }
        .btn-leave {
            background: var(--red);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }

        /* Main Game Area */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: calc(100vh - 60px);
        }

        /* Poker Table */
        .table-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin: 1rem auto;
            /* Fallback for Safari <15 that doesn't support aspect-ratio */
            height: 0;
            padding-bottom: 62.5%; /* 1/1.6 = 0.625 */
        }
        @supports (aspect-ratio: 1.6) {
            .table-container {
                height: auto;
                padding-bottom: 0;
                aspect-ratio: 1.6;
            }
        }
        .poker-table {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
            background: linear-gradient(145deg, var(--poker-felt), var(--poker-felt-dark));
            border-radius: 50%;
            border: 12px solid #5a3d2b;
            box-shadow:
                inset 0 0 60px rgba(0,0,0,0.4),
                0 10px 40px rgba(0,0,0,0.5);
        }
        .table-branding {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.25;
            pointer-events: none;
            z-index: 1;
        }
        .table-branding img {
            width: 80px;
            height: 80px;
            border-radius: 12px;
        }
        .table-branding .tagline {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        @media (max-width: 600px) {
            .table-branding img { width: 50px; height: 50px; }
            .table-branding .tagline { font-size: 0.6rem; letter-spacing: 1px; }
        }
        .table-rail {
            position: absolute;
            top: -15px; left: -15px; right: -15px; bottom: -15px;
            border-radius: 50%;
            border: 8px solid #3d2817;
            pointer-events: none;
        }

        /* Community Cards */
        .community-cards {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        /* Pot Display */
        .pot-display {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--gold);
            z-index: 10;
        }

        /* Player Seats */
        .seat {
            position: absolute;
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: translate(-50%, -50%);
            z-index: 20;
        }
        /* Seat positions around oval table */
        .seat-0 { top: 95%; left: 50%; }
        .seat-1 { top: 85%; left: 20%; }
        .seat-2 { top: 50%; left: 5%; }
        .seat-3 { top: 15%; left: 20%; }
        .seat-4 { top: 5%; left: 50%; }
        .seat-5 { top: 15%; left: 80%; }
        .seat-6 { top: 50%; left: 95%; }
        .seat-7 { top: 85%; left: 80%; }
        .seat-8 { top: 70%; left: 90%; }

        .player-info {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 100px;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }
        .player-info.active-turn {
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        .player-info.folded { opacity: 0.5; }
        .player-info.is-you { border-color: var(--blue); }
        .player-name {
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-chips {
            font-size: 0.75rem;
            color: var(--gold);
            font-weight: 700;
        }
        .player-action {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }
        .player-bet {
            position: absolute;
            background: rgba(0,0,0,0.7);
            padding: 0.25rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--gold);
            white-space: nowrap;
        }
        /* Bet chip positions */
        .seat-0 .player-bet { top: -30px; }
        .seat-1 .player-bet { top: -20px; right: -20px; }
        .seat-2 .player-bet { right: -40px; }
        .seat-3 .player-bet { bottom: -20px; right: -20px; }
        .seat-4 .player-bet { bottom: -30px; }
        .seat-5 .player-bet { bottom: -20px; left: -20px; }
        .seat-6 .player-bet { left: -40px; }
        .seat-7 .player-bet { top: -20px; left: -20px; }

        .player-cards {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        /* Dealer Button */
        .dealer-btn {
            position: absolute;
            width: 24px;
            height: 24px;
            background: linear-gradient(145deg, #fff, #ddd);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 800;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 25;
        }

        /* Cards */
        .card {
            width: 45px;
            height: 63px;
            background: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
        }
        .card.face-down {
            background: linear-gradient(135deg, #c41e3a, #8b0000);
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(255,255,255,0.1) 5px,
                rgba(255,255,255,0.1) 10px
            );
        }
        .card.hearts, .card.diamonds { color: #c41e3a; }
        .card.clubs, .card.spades { color: #1a1a1a; }
        .card-rank { position: absolute; top: 3px; left: 5px; font-size: 0.75rem; }
        .card-suit { font-size: 1.5rem; }
        .card-rank-bottom { position: absolute; bottom: 3px; right: 5px; font-size: 0.75rem; transform: rotate(180deg); }

        .community-cards .card {
            width: 55px;
            height: 77px;
        }
        .community-cards .card-suit { font-size: 1.8rem; }

        /* Action Panel */
        .action-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 100;
        }
        .action-panel.hidden { display: none; }
        .action-row {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .action-btn.fold { background: var(--red); color: white; }
        .action-btn.check { background: #6c757d; color: white; }
        .action-btn.call { background: var(--blue); color: white; }
        .action-btn.bet, .action-btn.raise { background: var(--poker-green); color: white; }
        .action-btn.all-in { background: linear-gradient(135deg, #ffd700, #ff8c00); color: #1a1a1a; }
        .action-btn:hover:not(:disabled) { transform: translateY(-2px); }

        .bet-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .bet-slider {
            width: 200px;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 4px;
            background: var(--border-color);
            outline: none;
        }
        .bet-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--gold);
            cursor: pointer;
        }
        .bet-amount {
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: var(--gold);
            font-weight: 700;
            font-size: 1.1rem;
            width: 100px;
            text-align: center;
        }
        .bet-presets {
            display: flex;
            gap: 0.5rem;
        }
        .bet-preset {
            padding: 0.4rem 0.75rem;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
        }
        .bet-preset:hover { border-color: var(--gold); color: var(--gold); }

        /* Waiting/Status Messages */
        .status-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 1.5rem 2rem;
            border-radius: 12px;
            text-align: center;
            z-index: 50;
        }
        .status-message h3 { margin-bottom: 0.5rem; font-size: 1.2rem; }
        .status-message p { color: var(--text-muted); }

        /* Winner Overlay */
        .winner-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .winner-overlay.show { display: flex; }
        .winner-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            max-width: 400px;
        }
        .winner-content h2 { color: var(--gold); margin-bottom: 0.5rem; font-size: 1.5rem; }
        .winner-hand { color: var(--text-secondary); margin-bottom: 1rem; }
        .winner-amount { font-size: 2rem; font-weight: 800; color: var(--gold); margin-bottom: 1rem; }
        .winner-btn {
            background: var(--poker-green);
            color: white;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Tournament Status Bar */
        .tournament-status-bar {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, var(--poker-green), #2a7a4d);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            font-size: 0.85rem;
            z-index: 90;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .tournament-status-bar.hidden { display: none; }
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-label {
            color: rgba(255,255,255,0.7);
            text-transform: uppercase;
            font-size: 0.7rem;
        }
        .status-value {
            color: white;
            font-weight: 700;
        }
        .blind-timer {
            background: rgba(0,0,0,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 1rem;
        }
        .blind-timer.warning { color: #ffcc00; }
        .blind-timer.critical { color: #ff4444; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Tournament Complete Overlay */
        .tournament-complete-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 250;
            align-items: center;
            justify-content: center;
        }
        .tournament-complete-overlay.show { display: flex; }
        .tournament-complete-content {
            background: linear-gradient(135deg, var(--card-bg), #1a1a1a);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 2rem 3rem;
            text-align: center;
            max-width: 500px;
        }
        .tournament-complete-content h2 {
            color: var(--gold);
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .prize-list {
            margin: 1.5rem 0;
        }
        .prize-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .prize-place { color: var(--text-secondary); }
        .prize-amount { color: var(--gold); font-weight: 700; }
        .prize-item.first-place { font-size: 1.2rem; }
        .prize-item.first-place .prize-place { color: var(--gold); }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 70px;
            left: 10px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 100;
            transition: all 0.3s;
        }
        .connection-status.connected {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }
        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
        .connection-status.reconnecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        .connection-status.reconnecting .connection-dot {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Action Timer */
        .action-timer {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
        }
        .action-timer.warning { color: #ffc107; }
        .action-timer.critical { color: #f44336; }

        /* Notification Toast */
        .notification-toast {
            position: fixed;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .notification-toast.show { opacity: 1; }
        .notification-toast.eliminated { border-color: var(--red); color: var(--red); }
        .notification-toast.info { border-color: var(--blue); }

        /* Test Controls */
        .test-panel {
            position: fixed;
            top: 60px;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px 0 0 8px;
            z-index: 150;
            transition: transform 0.3s;
        }
        .test-panel.collapsed {
            transform: translateX(calc(100% - 40px));
        }
        .test-panel-toggle {
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 100%;
            background: var(--poker-green);
            border: none;
            border-radius: 8px 0 0 8px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 0.5rem;
        }
        .test-panel-content {
            margin-left: 40px;
            padding: 1rem;
            width: 220px;
        }
        .test-panel h4 {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .test-btn {
            display: block;
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .test-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }
        .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .test-btn.primary {
            background: var(--poker-green);
            border-color: var(--poker-green);
        }
        .test-btn.primary:hover {
            background: #1d6b42;
        }
        .test-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--dark-bg);
            border-radius: 4px;
            max-height: 100px;
            overflow-y: auto;
        }
        .test-status.success { color: #4caf50; }
        .test-status.error { color: var(--red); }

        /* Responsive - Tablet */
        @media (max-width: 768px) {
            .table-container { aspect-ratio: 1.2; }
            .poker-table { width: 90%; height: 60%; }
            .seat { width: 90px; }
            .player-info { min-width: 80px; padding: 0.4rem; }
            .player-name { font-size: 0.75rem; }
            .card { width: 35px; height: 49px; }
            .community-cards .card { width: 42px; height: 59px; }
            .tournament-info { gap: 0.75rem; font-size: 0.75rem; }
            .action-btn { padding: 0.6rem 1rem; font-size: 0.9rem; min-width: 80px; }
            .tournament-status-bar { gap: 1rem; padding: 0.4rem 0.5rem; font-size: 0.75rem; }
            .test-panel { display: none; }
            .connection-status { top: auto; bottom: 10px; left: 10px; }
        }

        /* Responsive - Mobile */
        @media (max-width: 480px) {
            .header { padding: 0.5rem; }
            .header-left span { display: none; }
            .header-left img { width: 28px; height: 28px; }
            .tournament-info { display: none; }
            .coin-display { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
            .btn-leave { padding: 0.4rem 0.75rem; font-size: 0.75rem; }

            .table-container { aspect-ratio: 1; margin-top: 0; }
            .poker-table { width: 95%; height: 55%; }
            .seat { width: 70px; }
            .player-info { min-width: 60px; padding: 0.3rem; }
            .player-name { font-size: 0.65rem; max-width: 60px; }
            .player-chips { font-size: 0.6rem; }
            .player-action { font-size: 0.55rem; }
            .card { width: 28px; height: 39px; font-size: 0.9rem; }
            .card-rank { font-size: 0.6rem; }
            .card-suit { font-size: 1rem; }
            .community-cards .card { width: 36px; height: 50px; }
            .community-cards { gap: 0.3rem; }
            .pot-display { font-size: 0.9rem; padding: 0.4rem 0.75rem; top: 20%; }
            .dealer-btn { width: 20px; height: 20px; font-size: 0.55rem; }
            .player-bet { font-size: 0.6rem; padding: 0.2rem 0.4rem; }
            .player-cards { gap: 0.15rem; margin-top: 0.3rem; }

            /* Mobile seat positions - tighter layout */
            .seat-0 { top: 92%; }
            .seat-1 { top: 82%; left: 15%; }
            .seat-2 { top: 50%; left: 3%; }
            .seat-3 { top: 18%; left: 15%; }
            .seat-4 { top: 8%; }
            .seat-5 { top: 18%; left: 85%; }
            .seat-6 { top: 50%; left: 97%; }
            .seat-7 { top: 82%; left: 85%; }
            .seat-8 { top: 68%; left: 92%; }

            .tournament-status-bar {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0.3rem;
                font-size: 0.7rem;
            }
            .status-item { gap: 0.25rem; }
            .blind-timer { font-size: 0.85rem; padding: 0.2rem 0.5rem; }

            .action-panel {
                padding: 0.5rem;
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0px));
                gap: 0.5rem;
            }
            /* Minimum 44px touch targets for iOS */
            .action-btn { padding: 0.75rem 1rem; font-size: 0.85rem; min-width: 75px; min-height: 44px; }
            .bet-controls { flex-wrap: wrap; gap: 0.5rem; }
            .bet-slider { width: 150px; height: 44px; }
            .bet-amount { width: 80px; font-size: 0.9rem; padding: 0.5rem; min-height: 44px; }
            .bet-presets { gap: 0.35rem; }
            .bet-preset { padding: 0.5rem 0.6rem; font-size: 0.75rem; min-height: 36px; }

            .game-container { padding: 0.5rem; padding-bottom: calc(140px + env(safe-area-inset-bottom, 0px)); margin-top: 35px !important; }
            .winner-content { padding: 1.5rem; max-width: 90%; }
            .winner-content h2 { font-size: 1.2rem; }
            .winner-amount { font-size: 1.5rem; }

            .notification-toast { top: 100px; font-size: 0.8rem; padding: 0.5rem 1rem; }
        }

        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 0.3rem 0.5rem; }
            .tournament-status-bar { padding: 0.25rem; }
            .game-container { padding: 0.25rem; margin-top: 25px !important; }
            .table-container { padding-bottom: 50%; }
            .action-panel { padding: 0.3rem; padding-bottom: calc(0.3rem + env(safe-area-inset-bottom, 0px)); }
        }
        @supports (aspect-ratio: 2) {
            @media (max-height: 500px) and (orientation: landscape) {
                .table-container { padding-bottom: 0; aspect-ratio: 2; }
            }
        }

        /* Table Chat */
        .table-chat {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 0px);
            left: env(safe-area-inset-left, 0px);
            width: 320px;
            max-height: 300px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            border-radius: 0 12px 0 0;
            display: flex;
            flex-direction: column;
            z-index: 99;
            transition: transform 0.3s;
        }
        .table-chat.collapsed {
            transform: translateY(calc(100% - 40px));
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--poker-green);
            border-radius: 0 12px 0 0;
            cursor: pointer;
        }
        .chat-header h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chat-toggle {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .chat-unread {
            background: var(--red);
            color: white;
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: 700;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            max-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .chat-message {
            font-size: 0.8rem;
            padding: 0.35rem 0.5rem;
            background: var(--dark-bg);
            border-radius: 6px;
        }
        .chat-message .chat-user {
            font-weight: 700;
            color: var(--gold);
            margin-right: 0.35rem;
        }
        .chat-message .chat-text {
            color: var(--text-secondary);
        }
        .chat-message.system {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            font-style: italic;
            text-align: center;
        }
        .chat-message.system .chat-user { display: none; }
        .chat-input-row {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            border-top: 1px solid var(--border-color);
        }
        .chat-input {
            flex: 1;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .chat-input:focus {
            outline: none;
            border-color: var(--poker-green);
        }
        .chat-send {
            background: var(--poker-green);
            border: none;
            border-radius: 6px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .chat-send:hover {
            background: #1d6b42;
        }

        @media (max-width: 768px) {
            .table-chat {
                width: 100%;
                border-radius: 12px 12px 0 0;
                border-right: none;
            }
            .chat-header {
                border-radius: 12px 12px 0 0;
            }
        }

        @media (max-width: 480px) {
            .table-chat {
                max-height: 250px;
                bottom: env(safe-area-inset-bottom, 0px);
            }
            .chat-messages {
                max-height: 150px;
            }
            .chat-input {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
            .chat-send {
                min-height: 44px;
                min-width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="/">
                <img src="/logo.png" alt="PhillySports">
                <span>PhillySports</span>
            </a>
        </div>
        <div class="tournament-info" id="tournamentInfo">
            <div class="info-item">
                <span class="info-label">Blinds</span>
                <span class="info-value" id="blindsDisplay">10/20</span>
            </div>
            <div class="info-item">
                <span class="info-label">Level</span>
                <span class="info-value" id="levelDisplay">1</span>
            </div>
            <div class="info-item">
                <span class="info-label">Players</span>
                <span class="info-value" id="playersDisplay">0/0</span>
            </div>
        </div>
        <div class="header-right">
            <div class="coin-display">
                <span>&#129689;</span>
                <span id="userChips">0</span>
            </div>
            <a href="/poker.html" class="btn-leave">Leave Table</a>
        </div>
    </header>

    <!-- Tournament Status Bar -->
    <div class="tournament-status-bar hidden" id="tournamentStatusBar">
        <div class="status-item">
            <span class="status-label">Next Level In</span>
            <span class="status-value blind-timer" id="blindTimer">5:00</span>
        </div>
        <div class="status-item">
            <span class="status-label">Level</span>
            <span class="status-value" id="blindLevel">1</span>
        </div>
        <div class="status-item">
            <span class="status-label">Blinds</span>
            <span class="status-value" id="currentBlinds">10/20</span>
        </div>
        <div class="status-item">
            <span class="status-label">Ante</span>
            <span class="status-value" id="currentAnte">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">Players Left</span>
            <span class="status-value" id="playersLeft">0</span>
        </div>
    </div>

    <!-- Connection Status -->
    <div class="connection-status connected" id="connectionStatus">
        <span class="connection-dot"></span>
        <span id="connectionText">Connected</span>
    </div>

    <!-- Notification Toast -->
    <div class="notification-toast" id="notificationToast"></div>

    <!-- Tournament Complete Overlay -->
    <div class="tournament-complete-overlay" id="tournamentCompleteOverlay">
        <div class="tournament-complete-content">
            <h2>Tournament Complete!</h2>
            <p id="tournamentCompleteName" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
            <div class="prize-list" id="prizeList"></div>
            <button class="winner-btn" onclick="closeTournamentComplete()">Return to Lobby</button>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" style="margin-top: 40px;">
        <div class="table-container" id="tableContainer">
            <!-- Poker Table -->
            <div class="poker-table">
                <div class="table-rail"></div>
                <div class="table-branding">
                    <img src="/logo.png" alt="PhillySports.com">
                    <div class="tagline">Where the Diehards Play Hard</div>
                </div>
            </div>

            <!-- Pot Display -->
            <div class="pot-display" id="potDisplay">Pot: 0</div>

            <!-- Community Cards -->
            <div class="community-cards" id="communityCards"></div>

            <!-- Player Seats (will be populated by JS) -->
            <div id="seatsContainer"></div>

            <!-- Dealer Button -->
            <div class="dealer-btn" id="dealerBtn" style="display:none;">D</div>

            <!-- Status Message -->
            <div class="status-message" id="statusMessage" style="display:none;">
                <h3>Waiting for players...</h3>
                <p>The game will start when enough players join</p>
            </div>
        </div>
    </div>

    <!-- Test Controls Panel -->
    <div class="test-panel collapsed" id="testPanel">
        <button class="test-panel-toggle" onclick="toggleTestPanel()">Test</button>
        <div class="test-panel-content">
            <h4>Bot Testing</h4>
            <button class="test-btn" onclick="triggerBotAction()">Run Bot Action</button>
            <button class="test-btn" onclick="runBotLoop()">Auto-Play Bots</button>
            <button class="test-btn" id="stopBotsBtn" style="display:none;" onclick="stopBotLoop()">Stop Auto-Play</button>
            <hr style="border-color: var(--border-color); margin: 0.75rem 0;">
            <h4>Hand Control</h4>
            <button class="test-btn" onclick="startNewHand()">Start New Hand</button>
            <button class="test-btn" onclick="reloadState()">Refresh State</button>
            <div class="test-status" id="testStatus"></div>
        </div>
    </div>

    <!-- Action Panel -->
    <div class="action-panel hidden" id="actionPanel">
        <div class="bet-controls" id="betControls" style="display:none;">
            <div class="bet-presets">
                <button class="bet-preset" onclick="setBetPreset(0.5)">1/2 Pot</button>
                <button class="bet-preset" onclick="setBetPreset(0.75)">3/4 Pot</button>
                <button class="bet-preset" onclick="setBetPreset(1)">Pot</button>
            </div>
            <input type="range" class="bet-slider" id="betSlider" min="0" max="1000" value="0">
            <input type="number" class="bet-amount" id="betAmount" value="0">
        </div>
        <div class="action-row" id="actionButtons">
            <!-- Action buttons populated by JS -->
        </div>
    </div>

    <!-- Winner Overlay -->
    <div class="winner-overlay" id="winnerOverlay">
        <div class="winner-content">
            <h2 id="winnerName">Player Wins!</h2>
            <p class="winner-hand" id="winnerHand">Full House, Kings full of Aces</p>
            <div class="winner-amount" id="winnerAmount">+500</div>
            <button class="winner-btn" onclick="closeWinnerOverlay()">Continue</button>
        </div>
    </div>

    <!-- Table Chat -->
    <div class="table-chat collapsed" id="tableChat">
        <div class="chat-header" onclick="toggleChat()">
            <h4>
                <span>ðŸ’¬</span> Table Chat
                <span class="chat-unread" id="chatUnread" style="display:none;">0</span>
            </h4>
            <button class="chat-toggle" id="chatToggleBtn">â–²</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message system">
                <span class="chat-text">Welcome to the table!</span>
            </div>
        </div>
        <div class="chat-input-row">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="200" onkeypress="handleChatKeypress(event)">
            <button class="chat-send" onclick="sendChatMessage()">Send</button>
        </div>
    </div>

    <script>
        // Game State
        let tableId = null;
        let currentUser = null;
        let gameState = null;
        let pollInterval = null;
        let myPosition = null;
        let pusher = null;
        let tableChannel = null;
        let privateChannel = null;
        let myHoleCards = null;
        let usePusher = false;
        let isCashGame = false; // Cash game mode flag

        // Pusher configuration
        const PUSHER_KEY = 'YOUR_PUSHER_KEY'; // Will be replaced with actual key

        // Card rendering
        const SUITS = { h: { symbol: 'â™¥', class: 'hearts' }, d: { symbol: 'â™¦', class: 'diamonds' },
                       c: { symbol: 'â™£', class: 'clubs' }, s: { symbol: 'â™ ', class: 'spades' } };
        const RANKS = { '2': '2', '3': '3', '4': '4', '5': '5', '6': '6', '7': '7', '8': '8',
                       '9': '9', 'T': '10', 'J': 'J', 'Q': 'Q', 'K': 'K', 'A': 'A' };

        function renderCard(cardStr, faceDown = false) {
            if (!cardStr || faceDown) {
                return '<div class="card face-down"></div>';
            }
            const rank = cardStr[0];
            const suit = cardStr[1];
            const suitInfo = SUITS[suit] || { symbol: '?', class: '' };
            return `
                <div class="card ${suitInfo.class}">
                    <span class="card-rank">${RANKS[rank] || rank}</span>
                    <span class="card-suit">${suitInfo.symbol}</span>
                    <span class="card-rank-bottom">${RANKS[rank] || rank}</span>
                </div>
            `;
        }

        // Initialize
        async function init() {
            // Get table ID from URL
            const params = new URLSearchParams(window.location.search);
            tableId = params.get('table') || params.get('id') || params.get('tournament');

            // Check if this is a cash game
            const cashTableId = params.get('cash');
            if (cashTableId) {
                tableId = cashTableId;
                isCashGame = true;
                setupCashGameUI();
            }

            if (!tableId) {
                alert('No table specified');
                window.location.href = '/poker.html';
                return;
            }

            // Check auth
            await checkAuth();

            // Load initial state
            await loadGameState();

            // Initialize Pusher for real-time updates
            initPusher();

            // Start polling as fallback (slower if Pusher is active)
            pollInterval = setInterval(loadGameState, usePusher ? 10000 : 2000);
        }

        // Initialize Pusher connection
        function initPusher() {
            if (PUSHER_KEY === 'YOUR_PUSHER_KEY' || !PUSHER_KEY) {
                console.log('Pusher not configured, using polling');
                return;
            }

            try {
                pusher = new Pusher(PUSHER_KEY, {
                    cluster: 'us2',
                    authEndpoint: '/api/pusher/auth',
                    auth: {
                        headers: {}
                    }
                });

                // Subscribe to table channel (public events)
                tableChannel = pusher.subscribe(`table-${tableId}`);

                tableChannel.bind('new-hand', handleNewHand);
                tableChannel.bind('player-action', handlePlayerAction);
                tableChannel.bind('community-cards', handleCommunityCards);
                tableChannel.bind('hand-complete', handleHandComplete);
                tableChannel.bind('pot-update', handlePotUpdate);
                tableChannel.bind('blind-increase', handleBlindIncrease);
                tableChannel.bind('player-eliminated', handlePlayerEliminated);
                tableChannel.bind('tournament-complete', handleTournamentComplete);

                // Subscribe to private channel for hole cards
                if (currentUser) {
                    privateChannel = pusher.subscribe(`private-user-${currentUser.userId}`);
                    privateChannel.bind('hole-cards', handleHoleCards);
                }

                // Connection state handling
                pusher.connection.bind('connected', () => {
                    updateConnectionStatus('connected');
                    usePusher = true;
                });

                pusher.connection.bind('disconnected', () => {
                    updateConnectionStatus('disconnected');
                });

                pusher.connection.bind('connecting', () => {
                    updateConnectionStatus('reconnecting');
                });

                pusher.connection.bind('unavailable', () => {
                    updateConnectionStatus('disconnected');
                    // Fall back to faster polling
                    if (pollInterval) clearInterval(pollInterval);
                    pollInterval = setInterval(loadGameState, 2000);
                });

                usePusher = true;
                console.log('Pusher connected');

            } catch (e) {
                console.error('Pusher initialization failed:', e);
                usePusher = false;
                updateConnectionStatus('disconnected');
            }
        }

        // Connection status management
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');

            statusEl.className = 'connection-status ' + status;

            switch (status) {
                case 'connected':
                    textEl.textContent = 'Live';
                    break;
                case 'disconnected':
                    textEl.textContent = 'Offline';
                    showNotification('Connection lost. Reconnecting...', 'info');
                    break;
                case 'reconnecting':
                    textEl.textContent = 'Reconnecting...';
                    break;
            }
        }

        // Notification toast
        let notificationTimeout = null;
        function showNotification(message, type = '') {
            const toast = document.getElementById('notificationToast');
            toast.textContent = message;
            toast.className = 'notification-toast show' + (type ? ' ' + type : '');

            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Pusher event handlers
        function handleNewHand(data) {
            console.log('New hand:', data);
            myHoleCards = null; // Reset hole cards
            loadGameState(); // Refresh full state
        }

        function handlePlayerAction(data) {
            console.log('Player action:', data);
            // Update pot and current bet immediately
            if (gameState && gameState.table && gameState.table.currentHand) {
                gameState.table.currentHand.pot = data.pot;
                gameState.table.currentHand.currentBet = data.currentBet;
                gameState.table.currentHand.actingPosition = data.actingPosition;
                gameState.table.currentHand.status = data.status;

                // Update the player who acted
                const seat = gameState.table.seats.find(s => s.position === data.position);
                if (seat) {
                    seat.lastAction = data.action;
                }
            }
            renderTable();
            loadGameState(); // Get full updated state
        }

        function handleCommunityCards(data) {
            console.log('Community cards:', data);
            if (gameState && gameState.table && gameState.table.currentHand) {
                gameState.table.currentHand.communityCards = data.communityCards;
                gameState.table.currentHand.status = data.status;
            }
            renderTable();
        }

        function handleHandComplete(data) {
            console.log('Hand complete:', data);
            if (data.winners && data.winners.length > 0) {
                showWinner(data.winners[0]);
            }
            loadGameState(); // Refresh full state
        }

        function handlePotUpdate(data) {
            if (gameState && gameState.table && gameState.table.currentHand) {
                gameState.table.currentHand.pot = data.pot;
            }
            document.getElementById('potDisplay').textContent = `Pot: ${data.pot}`;
        }

        function handleHoleCards(data) {
            console.log('Received hole cards:', data);
            if (data.tableId === tableId) {
                myHoleCards = data.cards;
                renderTable();
            }
        }

        function handleBlindIncrease(data) {
            console.log('Blind increase:', data);
            // Update UI immediately
            document.getElementById('blindLevel').textContent = data.level;
            document.getElementById('currentBlinds').textContent = `${data.smallBlind}/${data.bigBlind}`;
            document.getElementById('currentAnte').textContent = data.ante || 0;
            document.getElementById('blindsDisplay').textContent = `${data.smallBlind}/${data.bigBlind}`;
            document.getElementById('levelDisplay').textContent = data.level;

            // Flash the status bar
            const statusBar = document.getElementById('tournamentStatusBar');
            statusBar.style.background = 'linear-gradient(90deg, #ff6600, #cc4400)';
            setTimeout(() => {
                statusBar.style.background = 'linear-gradient(90deg, var(--poker-green), #2a7a4d)';
            }, 2000);

            loadGameState(); // Refresh for new timer
        }

        function handlePlayerEliminated(data) {
            console.log('Player eliminated:', data);
            document.getElementById('playersLeft').textContent = data.remainingPlayers;

            // Show elimination notification
            const isMe = currentUser && data.playerId === currentUser.userId;
            if (isMe) {
                showNotification(`You finished in ${getOrdinal(data.position)} place!`, 'eliminated');
            } else {
                showNotification(`${data.username || 'Player'} eliminated (${data.remainingPlayers} left)`, 'info');
            }
            loadGameState();
        }

        function handleTournamentComplete(data) {
            console.log('Tournament complete:', data);
            showTournamentComplete(data);
        }

        // Tournament status functions
        let blindTimerInterval = null;
        let nextBlindTime = null;

        function updateTournamentStatus() {
            if (!gameState || !gameState.table || !gameState.table.tournament) {
                document.getElementById('tournamentStatusBar').classList.add('hidden');
                return;
            }

            const tournament = gameState.table.tournament;
            const statusBar = document.getElementById('tournamentStatusBar');
            statusBar.classList.remove('hidden');

            // Update blind level info
            const currentBlinds = tournament.blindStructure?.[tournament.currentBlindLevel || 0];
            if (currentBlinds) {
                document.getElementById('blindLevel').textContent = (tournament.currentBlindLevel || 0) + 1;
                document.getElementById('currentBlinds').textContent = `${currentBlinds.smallBlind}/${currentBlinds.bigBlind}`;
                document.getElementById('currentAnte').textContent = currentBlinds.ante || 0;
            }

            // Update players left
            document.getElementById('playersLeft').textContent = tournament.registeredCount || 0;

            // Start blind timer if we have next blind time
            if (tournament.nextBlindIncrease) {
                nextBlindTime = new Date(tournament.nextBlindIncrease);
                if (!blindTimerInterval) {
                    blindTimerInterval = setInterval(updateBlindTimer, 1000);
                }
                updateBlindTimer();
            }
        }

        function updateBlindTimer() {
            if (!nextBlindTime) return;

            const now = new Date();
            const diff = Math.max(0, nextBlindTime - now);
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            const timerEl = document.getElementById('blindTimer');
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // Color coding
            timerEl.classList.remove('warning', 'critical');
            if (diff < 30000) {
                timerEl.classList.add('critical');
            } else if (diff < 60000) {
                timerEl.classList.add('warning');
            }

            // Check blinds when timer hits zero
            if (diff === 0) {
                checkBlinds();
            }
        }

        async function checkBlinds() {
            if (!gameState || !gameState.table || !gameState.table.tournamentId) return;

            try {
                const response = await fetch('/api/poker/tournaments/check-blinds', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tournamentId: gameState.table.tournamentId })
                });
                const data = await response.json();

                if (data.advanced) {
                    // Blinds advanced, update UI
                    document.getElementById('blindLevel').textContent = data.newLevel + 1;
                    document.getElementById('currentBlinds').textContent =
                        `${data.newBlinds.smallBlind}/${data.newBlinds.bigBlind}`;
                    document.getElementById('currentAnte').textContent = data.newBlinds.ante || 0;
                }

                if (data.timeUntilNextLevel) {
                    nextBlindTime = new Date(Date.now() + data.timeUntilNextLevel * 1000);
                }
            } catch (e) {
                console.error('Check blinds error:', e);
            }
        }

        function showTournamentComplete(data) {
            const overlay = document.getElementById('tournamentCompleteOverlay');
            document.getElementById('tournamentCompleteName').textContent = data.tournamentName || 'Tournament';

            const prizeList = document.getElementById('prizeList');
            prizeList.innerHTML = '';

            if (data.winners) {
                for (const winner of data.winners) {
                    const isFirst = winner.place === 1;
                    prizeList.innerHTML += `
                        <div class="prize-item ${isFirst ? 'first-place' : ''}">
                            <span class="prize-place">${getOrdinal(winner.place)} Place</span>
                            <span class="prize-amount">${winner.prize} coins</span>
                        </div>
                    `;
                }
            }

            overlay.classList.add('show');
        }

        function closeTournamentComplete() {
            document.getElementById('tournamentCompleteOverlay').classList.remove('show');
            window.location.href = '/poker.html';
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return n + (s[(v - 20) % 10] || s[v] || s[0]);
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                if (data.user) {
                    currentUser = data.user;
                } else {
                    alert('Please login to play');
                    window.location.href = '/login.html';
                }
            } catch (e) {
                window.location.href = '/login.html';
            }
        }

        async function loadGameState() {
            try {
                const apiPath = isCashGame
                    ? `/api/poker/cash-games/${tableId}`
                    : `/api/poker/tables/${tableId}`;

                const response = await fetch(apiPath);
                const data = await response.json();

                if (!data.success) {
                    showStatus('Error loading table', data.error);
                    return;
                }

                gameState = data;
                renderTable();
                renderActionPanel(data.validActions, data.isYourTurn);

                if (isCashGame) {
                    updateCashGameUI();
                } else {
                    updateTournamentStatus();
                }

            } catch (e) {
                console.error('Error loading game state:', e);
            }
        }

        function renderTable() {
            const table = gameState.table;
            // For cash games, currentHand is at top level; for tournaments, it's inside table
            const hand = gameState.currentHand || table.currentHand;

            // Update tournament info
            if (table.tournament) {
                const blinds = table.tournament.blindStructure?.[table.tournament.currentBlindLevel || 0];
                if (blinds) {
                    document.getElementById('blindsDisplay').textContent = `${blinds.smallBlind}/${blinds.bigBlind}`;
                }
                document.getElementById('levelDisplay').textContent = (table.tournament.currentBlindLevel || 0) + 1;
                document.getElementById('playersDisplay').textContent = `${table.tournament.registeredCount}/${table.tournament.maxPlayers}`;
            }

            // Update user chips - for cash games, userSeat is at top level
            let userSeat = gameState.userSeat || table.userSeat;

            // Fallback: find user's seat in the table seats array if not found
            if (!userSeat && currentUser && table.seats) {
                const mySeat = table.seats.find(s =>
                    s.playerId === currentUser._id ||
                    s.username === currentUser.username ||
                    s.username === currentUser.displayName
                );
                if (mySeat) {
                    userSeat = {
                        position: mySeat.position,
                        chipStack: mySeat.chipStack,
                        isActive: mySeat.isActive
                    };
                }
            }

            if (userSeat) {
                document.getElementById('userChips').textContent = userSeat.chipStack;
                myPosition = userSeat.position;
            } else if (gameState.isSeated) {
                // User is seated but we couldn't find the seat - try to get from hand players
                const handPlayer = hand?.players?.find(p => !table.seats.find(s => s.playerId === p.playerId && s.isBot));
                if (handPlayer) {
                    document.getElementById('userChips').textContent = handPlayer.chipStackCurrent;
                    myPosition = handPlayer.position;
                }
            }

            // Render pot
            const pot = hand?.pot || 0;
            document.getElementById('potDisplay').textContent = `Pot: ${pot}`;

            // Render community cards
            const communityEl = document.getElementById('communityCards');
            if (hand?.communityCards?.length > 0) {
                communityEl.innerHTML = hand.communityCards.map(c => renderCard(c)).join('');
            } else {
                communityEl.innerHTML = '';
            }

            // Render seats
            renderSeats(table.seats, hand);

            // Render dealer button
            renderDealerButton(table.dealerPosition);

            // Check for winner
            if (hand?.status === 'complete' && hand?.winners?.length > 0) {
                showWinner(hand.winners[0]);
            }

            // Show/hide status message
            if (!hand) {
                showStatus('Waiting for hand to start...', 'The next hand will begin shortly');
            } else {
                hideStatus();
            }
        }

        function renderSeats(seats, hand) {
            const container = document.getElementById('seatsContainer');
            container.innerHTML = '';

            // Position mapping for visual layout
            const positions = [0, 1, 2, 3, 4, 5, 6, 7, 8];

            for (const pos of positions) {
                const seat = seats.find(s => s.position === pos);
                if (!seat) continue;

                const handPlayer = hand?.players?.find(p => p.position === pos);
                const isActive = hand && handPlayer && !handPlayer.isFolded;
                const isCurrentTurn = hand && hand.actingPosition === pos;
                const isMe = seat.username === currentUser?.username;

                let classes = `seat seat-${pos}`;

                const seatEl = document.createElement('div');
                seatEl.className = classes;

                if (seat.playerId) {
                    let playerClasses = 'player-info';
                    if (isCurrentTurn) playerClasses += ' active-turn';
                    if (handPlayer?.isFolded) playerClasses += ' folded';
                    if (isMe) playerClasses += ' is-you';

                    // Player cards
                    let cardsHtml = '';
                    if (hand && isActive) {
                        // Check for cards from Pusher (myHoleCards), API (table.userSeat.cards), or showdown (handPlayer.holeCards)
                        if (isMe && (myHoleCards || table?.userSeat?.cards)) {
                            const cards = myHoleCards || table.userSeat.cards;
                            cardsHtml = `<div class="player-cards">${cards.map(c => renderCard(c)).join('')}</div>`;
                        } else if (handPlayer?.holeCards) {
                            cardsHtml = `<div class="player-cards">${handPlayer.holeCards.map(c => renderCard(c)).join('')}</div>`;
                        } else if (!handPlayer?.isFolded) {
                            cardsHtml = `<div class="player-cards">${renderCard(null, true)}${renderCard(null, true)}</div>`;
                        }
                    }

                    // Current bet
                    let betHtml = '';
                    if (handPlayer?.currentRoundBet > 0) {
                        betHtml = `<div class="player-bet">${handPlayer.currentRoundBet}</div>`;
                    }

                    // Action text
                    let actionText = '';
                    if (handPlayer?.isFolded) actionText = 'Folded';
                    else if (handPlayer?.isAllIn) actionText = 'All-In';
                    else if (seat.lastAction) actionText = seat.lastAction;

                    seatEl.innerHTML = `
                        <div class="${playerClasses}">
                            <div class="player-name">${isMe ? 'â˜… ' : ''}${seat.username}</div>
                            <div class="player-chips">${seat.chipStack}</div>
                            ${actionText ? `<div class="player-action">${actionText}</div>` : ''}
                        </div>
                        ${cardsHtml}
                        ${betHtml}
                    `;
                } else {
                    seatEl.innerHTML = `
                        <div class="player-info" style="opacity:0.3;">
                            <div class="player-name">Empty</div>
                        </div>
                    `;
                }

                container.appendChild(seatEl);
            }
        }

        function renderDealerButton(dealerPos) {
            const btn = document.getElementById('dealerBtn');
            if (dealerPos === undefined || dealerPos === null) {
                btn.style.display = 'none';
                return;
            }

            btn.style.display = 'flex';

            // Position dealer button near the dealer seat
            const positions = {
                0: { top: '88%', left: '45%' },
                1: { top: '78%', left: '25%' },
                2: { top: '48%', left: '12%' },
                3: { top: '20%', left: '25%' },
                4: { top: '12%', left: '45%' },
                5: { top: '20%', left: '75%' },
                6: { top: '48%', left: '88%' },
                7: { top: '78%', left: '75%' },
                8: { top: '65%', left: '85%' }
            };

            const pos = positions[dealerPos] || positions[0];
            btn.style.top = pos.top;
            btn.style.left = pos.left;
        }

        function renderActionPanel(validActions, isYourTurn) {
            const panel = document.getElementById('actionPanel');
            const buttonsEl = document.getElementById('actionButtons');
            const betControls = document.getElementById('betControls');

            if (!isYourTurn || !validActions || validActions.length === 0) {
                panel.classList.add('hidden');
                return;
            }

            panel.classList.remove('hidden');

            const hand = gameState.table.currentHand;
            const toCall = hand ? hand.currentBet - (hand.players.find(p => p.position === myPosition)?.currentRoundBet || 0) : 0;
            const myChips = gameState.table.userSeat?.chipStack || 0;

            let buttonsHtml = '';

            if (validActions.includes('fold')) {
                buttonsHtml += `<button class="action-btn fold" onclick="doAction('fold')">Fold</button>`;
            }
            if (validActions.includes('check')) {
                buttonsHtml += `<button class="action-btn check" onclick="doAction('check')">Check</button>`;
            }
            if (validActions.includes('call')) {
                buttonsHtml += `<button class="action-btn call" onclick="doAction('call')">Call ${toCall}</button>`;
            }
            if (validActions.includes('bet')) {
                buttonsHtml += `<button class="action-btn bet" onclick="doAction('bet', getBetAmount())">Bet</button>`;
                showBetControls(hand.minRaise, myChips, hand.pot);
            } else if (validActions.includes('raise')) {
                buttonsHtml += `<button class="action-btn raise" onclick="doAction('raise', getBetAmount())">Raise</button>`;
                showBetControls(hand.currentBet + hand.minRaise, myChips, hand.pot);
            } else {
                betControls.style.display = 'none';
            }
            if (validActions.includes('all_in')) {
                buttonsHtml += `<button class="action-btn all-in" onclick="doAction('all_in')">All-In (${myChips})</button>`;
            }

            buttonsEl.innerHTML = buttonsHtml;
        }

        function showBetControls(minBet, maxBet, pot) {
            const controls = document.getElementById('betControls');
            const slider = document.getElementById('betSlider');
            const amount = document.getElementById('betAmount');

            controls.style.display = 'flex';
            slider.min = minBet;
            slider.max = maxBet;
            slider.value = minBet;
            amount.value = minBet;

            slider.oninput = () => { amount.value = slider.value; };
            amount.oninput = () => { slider.value = amount.value; };
        }

        function setBetPreset(multiplier) {
            const pot = gameState.table.currentHand?.pot || 0;
            const amount = Math.floor(pot * multiplier);
            const slider = document.getElementById('betSlider');
            const amountInput = document.getElementById('betAmount');
            const minBet = parseInt(slider.min);
            const maxBet = parseInt(slider.max);
            const finalAmount = Math.max(minBet, Math.min(maxBet, amount));
            slider.value = finalAmount;
            amountInput.value = finalAmount;
        }

        function getBetAmount() {
            return parseInt(document.getElementById('betAmount').value) || 0;
        }

        async function doAction(action, amount = 0) {
            try {
                const apiPath = isCashGame
                    ? `/api/poker/cash-games/${tableId}/action`
                    : `/api/poker/tables/${tableId}/action`;

                const response = await fetch(apiPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action,
                        amount,
                        handId: gameState.table?.currentHand?._id || gameState.currentHand?._id
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    alert(data.error || 'Action failed');
                    return;
                }

                // Immediately reload state
                await loadGameState();

                // For cash games, poll more frequently for a bit to catch bot actions
                // (bot actions are triggered server-side with a delay)
                if (isCashGame && !data.isHandComplete) {
                    // Poll a few times quickly to catch bot action
                    for (let i = 0; i < 3; i++) {
                        await new Promise(r => setTimeout(r, 1500));
                        await loadGameState();
                    }
                }

            } catch (e) {
                console.error('Action error:', e);
                alert('Action failed');
            }
        }

        function showStatus(title, message) {
            const el = document.getElementById('statusMessage');
            el.querySelector('h3').textContent = title;
            el.querySelector('p').textContent = message;
            el.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        function showWinner(winner) {
            const overlay = document.getElementById('winnerOverlay');
            document.getElementById('winnerName').textContent = `Winner!`;
            document.getElementById('winnerHand').textContent = winner.handDescription || '';
            document.getElementById('winnerAmount').textContent = `+${winner.amount}`;
            overlay.classList.add('show');
        }

        function closeWinnerOverlay() {
            document.getElementById('winnerOverlay').classList.remove('show');
        }

        // Cleanup on page leave
        window.addEventListener('beforeunload', () => {
            if (pollInterval) clearInterval(pollInterval);
            if (botLoopInterval) clearInterval(botLoopInterval);
            if (blindTimerInterval) clearInterval(blindTimerInterval);
            if (chatPollInterval) clearInterval(chatPollInterval);
            if (pusher) {
                pusher.disconnect();
            }
        });

        // ============ Test Controls ============
        let botLoopInterval = null;

        function toggleTestPanel() {
            document.getElementById('testPanel').classList.toggle('collapsed');
        }

        function setTestStatus(message, type = '') {
            const el = document.getElementById('testStatus');
            el.textContent = message;
            el.className = 'test-status' + (type ? ' ' + type : '');
        }

        async function triggerBotAction() {
            setTestStatus('Running bot action...');
            try {
                // Use cash game bot endpoint if in cash game mode
                const endpoint = isCashGame
                    ? `/api/poker/cash-games/${tableId}/bot-action`
                    : '/api/poker/test/bot-action';

                const body = isCashGame ? {} : { tableId };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();

                if (data.success) {
                    if (data.isBot === false) {
                        setTestStatus(`Waiting for ${data.waitingFor}`);
                    } else if (data.handComplete) {
                        setTestStatus('Hand complete!', 'success');
                    } else if (data.needsNewHand) {
                        setTestStatus('No active hand. Start one!');
                    } else {
                        setTestStatus(`${data.bot}: ${data.action} ${data.amount || ''}`, 'success');
                    }
                } else {
                    setTestStatus(data.error || 'Bot action failed', 'error');
                }

                await loadGameState();
            } catch (e) {
                setTestStatus('Error: ' + e.message, 'error');
            }
        }

        function runBotLoop() {
            if (botLoopInterval) return;

            document.getElementById('stopBotsBtn').style.display = 'block';
            setTestStatus('Auto-play running...');

            // Use cash game bot endpoint if in cash game mode
            const endpoint = isCashGame
                ? `/api/poker/cash-games/${tableId}/bot-action`
                : '/api/poker/test/bot-action';
            const body = isCashGame ? {} : { tableId };

            botLoopInterval = setInterval(async () => {
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();

                    if (data.success) {
                        if (data.isBot === false) {
                            setTestStatus(`Your turn! (${data.waitingFor})`);
                        } else if (data.handComplete) {
                            setTestStatus('Hand complete! Starting new...', 'success');
                            // For cash games, new hand starts automatically
                            if (!isCashGame) {
                                setTimeout(startNewHand, 1500);
                            }
                        } else if (data.needsNewHand) {
                            setTestStatus('Starting new hand...');
                            if (!isCashGame) {
                                startNewHand();
                            }
                        } else {
                            setTestStatus(`${data.bot}: ${data.action}`, 'success');
                        }
                    }

                    await loadGameState();
                } catch (e) {
                    console.error('Bot loop error:', e);
                }
            }, 1500); // Slightly slower for cash games
        }

        function stopBotLoop() {
            if (botLoopInterval) {
                clearInterval(botLoopInterval);
                botLoopInterval = null;
            }
            document.getElementById('stopBotsBtn').style.display = 'none';
            setTestStatus('Auto-play stopped');
        }

        async function startNewHand() {
            setTestStatus('Starting new hand...');
            try {
                const response = await fetch('/api/poker/tables/' + tableId + '/new-hand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    setTestStatus('New hand started!', 'success');
                } else {
                    setTestStatus(data.error || 'Failed to start hand', 'error');
                }

                await loadGameState();
            } catch (e) {
                setTestStatus('Error: ' + e.message, 'error');
            }
        }

        async function reloadState() {
            setTestStatus('Refreshing...');
            await loadGameState();
            setTestStatus('State refreshed', 'success');
        }

        // Cash Game Functions
        function setupCashGameUI() {
            // Hide tournament-specific elements
            document.getElementById('tournamentStatusBar').classList.add('hidden');
            document.getElementById('levelDisplay').parentElement.style.display = 'none';

            // Update header to show cash game info
            document.getElementById('blindsDisplay').textContent = '10/20';

            // Change Leave Table button behavior for cash games
            const leaveBtn = document.querySelector('.btn-leave');
            if (leaveBtn) {
                leaveBtn.textContent = 'Cash Out';
                leaveBtn.href = '#';
                leaveBtn.onclick = (e) => {
                    e.preventDefault();
                    leaveCashTable();
                };
            }

            // Update title
            document.title = 'Cash Game | PhillySports.com';
        }

        function updateCashGameUI() {
            const table = gameState.table;

            // Update blinds display
            document.getElementById('blindsDisplay').textContent =
                `${table.blinds?.small || 10}/${table.blinds?.big || 20}`;

            // Update players display
            const playerCount = table.seats.filter(s => s.playerId).length;
            document.getElementById('playersDisplay').textContent = `${playerCount}/2`;

            // Show rebuy button if player is busted
            if (gameState.canRebuy) {
                showRebuyOption();
            } else {
                hideRebuyOption();
            }

            // Update leave button state
            const leaveBtn = document.querySelector('.btn-leave');
            if (leaveBtn) {
                if (gameState.canLeave) {
                    leaveBtn.style.opacity = '1';
                    leaveBtn.style.cursor = 'pointer';
                } else {
                    leaveBtn.style.opacity = '0.5';
                    leaveBtn.style.cursor = 'not-allowed';
                }
            }
        }

        function showRebuyOption() {
            // Add rebuy button if not already present
            if (!document.getElementById('rebuyBtn')) {
                const actionPanel = document.getElementById('actionPanel');
                const rebuyBtn = document.createElement('button');
                rebuyBtn.id = 'rebuyBtn';
                rebuyBtn.className = 'action-btn call';
                rebuyBtn.style.background = '#ffc107';
                rebuyBtn.style.color = '#000';
                rebuyBtn.textContent = 'Rebuy (1,000 DD)';
                rebuyBtn.onclick = rebuyCashGame;
                actionPanel.insertBefore(rebuyBtn, actionPanel.firstChild);
                actionPanel.classList.remove('hidden');
            }
        }

        function hideRebuyOption() {
            const rebuyBtn = document.getElementById('rebuyBtn');
            if (rebuyBtn) {
                rebuyBtn.remove();
            }
        }

        async function leaveCashTable() {
            if (!gameState.canLeave) {
                alert('Cannot leave during an active hand. Fold first or wait for the hand to complete.');
                return;
            }

            const chipStack = gameState.userSeat?.chipStack || 0;
            if (!confirm(`Cash out and leave table? You will receive ${chipStack} Diehard Dollars.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/poker/cash-games/${tableId}/leave`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Cashed out ${data.cashOut} Diehard Dollars!`);
                    window.location.href = '/poker.html';
                } else {
                    alert(data.error || 'Failed to leave table');
                }
            } catch (e) {
                alert('Failed to leave table');
            }
        }

        async function rebuyCashGame() {
            if (!confirm('Buy back in for 1,000 Diehard Dollars?')) {
                return;
            }

            try {
                const response = await fetch(`/api/poker/cash-games/${tableId}/rebuy`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    alert('Rebuy successful! You have 1,000 chips.');
                    hideRebuyOption();
                    await loadGameState();
                } else {
                    alert(data.error || 'Rebuy failed');
                }
            } catch (e) {
                alert('Rebuy failed');
            }
        }

        // ============ Table Chat ============
        let chatMessages = [];
        let lastChatId = null;
        let chatPollInterval = null;
        let unreadCount = 0;
        let chatExpanded = false;

        function toggleChat() {
            const chat = document.getElementById('tableChat');
            const toggleBtn = document.getElementById('chatToggleBtn');
            chatExpanded = !chatExpanded;

            if (chatExpanded) {
                chat.classList.remove('collapsed');
                toggleBtn.textContent = 'â–¼';
                // Clear unread count when opened
                unreadCount = 0;
                updateUnreadBadge();
                // Scroll to bottom
                const messagesEl = document.getElementById('chatMessages');
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } else {
                chat.classList.add('collapsed');
                toggleBtn.textContent = 'â–²';
            }
        }

        function updateUnreadBadge() {
            const badge = document.getElementById('chatUnread');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message || !tableId || !currentUser) return;

            input.value = '';

            try {
                const response = await fetch(`/api/poker/tables/${tableId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success && data.message) {
                    appendChatMessage(data.message);
                }
            } catch (e) {
                console.error('Failed to send chat message:', e);
            }
        }

        async function loadChatMessages() {
            if (!tableId) return;

            try {
                const url = lastChatId
                    ? `/api/poker/tables/${tableId}/chat?after=${lastChatId}`
                    : `/api/poker/tables/${tableId}/chat`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success && data.messages) {
                    for (const msg of data.messages) {
                        appendChatMessage(msg);
                    }
                }
            } catch (e) {
                console.error('Failed to load chat messages:', e);
            }
        }

        function appendChatMessage(msg) {
            // Check if message already displayed
            if (document.querySelector(`[data-msg-id="${msg._id}"]`)) return;

            const messagesEl = document.getElementById('chatMessages');
            const isSystem = msg.type === 'system';
            const isMe = msg.userId === currentUser?.userId;

            const msgEl = document.createElement('div');
            msgEl.className = 'chat-message' + (isSystem ? ' system' : '');
            msgEl.setAttribute('data-msg-id', msg._id);

            if (isSystem) {
                msgEl.innerHTML = `<span class="chat-text">${escapeHtml(msg.message)}</span>`;
            } else {
                msgEl.innerHTML = `
                    <span class="chat-user">${escapeHtml(msg.username)}:</span>
                    <span class="chat-text">${escapeHtml(msg.message)}</span>
                `;
            }

            messagesEl.appendChild(msgEl);
            lastChatId = msg._id;

            // Scroll to bottom if chat is open
            if (chatExpanded) {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } else if (!isMe) {
                // Increment unread if chat is closed and not own message
                unreadCount++;
                updateUnreadBadge();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function startChatPolling() {
            // Initial load
            loadChatMessages();
            // Poll every 3 seconds for new messages
            chatPollInterval = setInterval(loadChatMessages, 3000);
        }

        function stopChatPolling() {
            if (chatPollInterval) {
                clearInterval(chatPollInterval);
                chatPollInterval = null;
            }
        }

        // Initialize
        init();
        startChatPolling();
    </script>
</body>
</html>

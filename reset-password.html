<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics (excludes admin users) -->
    <script>
    if (localStorage.getItem('isAdmin') !== 'true') {
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=G-KRBRNKNC97';
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KRBRNKNC97');
    }
    </script>
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1980537474373781" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password | PhillySports.com</title>
    <meta name="description" content="Create a new password for your PhillySports.com account.">
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/mobile-menu.css">
    <style>
        :root {
            --eagles-green: #004C54;
            --phillies-red: #E81828;
            --sixers-blue: #006BB6;
            --flyers-orange: #F74902;
            --dark-bg: #faf9f6;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-muted: #888888;
            --nav-text: #333333;
            --accent-color: #8b0000;
        }
        [data-theme="dark"] {
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --nav-text: #d0d0d0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }
        a { color: inherit; text-decoration: none; }

        .main-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 2rem; }

        .auth-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 420px; padding: 2rem; }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-header h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 0.5rem; }
        .auth-header p { color: var(--text-secondary); font-size: 0.9rem; }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-weight: 600; font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-primary); }
        .form-group input { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; font-family: inherit; background: var(--card-bg); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--sixers-blue); box-shadow: 0 0 0 3px rgba(0,107,182,0.1); }
        .form-group input::placeholder { color: var(--text-muted); }
        .form-group small { display: block; margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8rem; }

        .password-strength { height: 4px; border-radius: 2px; background: var(--border-color); margin-top: 0.5rem; overflow: hidden; }
        .password-strength-bar { height: 100%; width: 0; transition: width 0.3s, background 0.3s; }
        .password-strength-bar.weak { width: 33%; background: #dc2626; }
        .password-strength-bar.medium { width: 66%; background: #f59e0b; }
        .password-strength-bar.strong { width: 100%; background: #16a34a; }

        .btn { width: 100%; padding: 0.875rem 1rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--phillies-red), var(--flyers-orange)); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .auth-footer { margin-top: 1.5rem; text-align: center; font-size: 0.9rem; color: var(--text-secondary); }
        .auth-footer a { color: var(--sixers-blue); font-weight: 600; }
        .auth-footer a:hover { text-decoration: underline; }

        .error-message { background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
        .error-message.show { display: block; }

        .success-message { background: #dcfce7; border: 1px solid #bbf7d0; color: #16a34a; padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; text-align: center; }
        .success-message.show { display: block; }

        .footer { padding: 1rem; background: var(--card-bg); border-top: 1px solid var(--border-color); text-align: center; }
        .footer-copy { color: var(--text-muted); font-size: 0.75rem; }

        .invalid-token { text-align: center; }
        .invalid-token h1 { color: #dc2626; margin-bottom: 1rem; }

    </style>
</head>
<body>
    <!-- Shared Header -->
    <div id="site-header"></div>
    <script src="/js/header.js"></script>

    <main class="main-container">
        <div class="auth-card" id="resetForm">
            <div class="auth-header">
                <h1>Create New Password</h1>
                <p>Enter a new password for your account</p>
            </div>

            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <form id="passwordForm">
                <div class="form-group">
                    <label for="password">New Password</label>
                    <input type="password" id="password" name="password" placeholder="Enter new password" required minlength="8">
                    <div class="password-strength">
                        <div class="password-strength-bar" id="strengthBar"></div>
                    </div>
                    <small>At least 8 characters with uppercase, lowercase, and number</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm new password" required>
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn">Reset Password</button>
            </form>

            <div class="auth-footer">
                <p>Remember your password? <a href="/login.html">Sign in</a></p>
            </div>
        </div>

        <div class="auth-card invalid-token" id="invalidToken" style="display: none;">
            <div class="auth-header">
                <h1>Invalid or Expired Link</h1>
                <p>This password reset link is no longer valid.</p>
            </div>
            <a href="/forgot-password.html" class="btn btn-primary">Request New Link</a>
            <div class="auth-footer">
                <p>Remember your password? <a href="/login.html">Sign in</a></p>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p class="footer-copy">&copy; 2025 PhillySports.com. All rights reserved.</p>
    </footer>

    <script>
        // Dark Mode Toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // Get token from URL
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            document.getElementById('resetForm').style.display = 'none';
            document.getElementById('invalidToken').style.display = 'block';
        }

        // Password strength indicator
        document.getElementById('password').addEventListener('input', (e) => {
            const password = e.target.value;
            const strengthBar = document.getElementById('strengthBar');

            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z0-9]/.test(password)) strength++;

            strengthBar.className = 'password-strength-bar';
            if (strength >= 3) {
                strengthBar.classList.add('strong');
            } else if (strength >= 2) {
                strengthBar.classList.add('medium');
            } else if (strength >= 1) {
                strengthBar.classList.add('weak');
            }
        });

        // Handle form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                errorMessage.textContent = 'Passwords do not match';
                errorMessage.classList.add('show');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                errorMessage.textContent = 'Password must be at least 8 characters';
                errorMessage.classList.add('show');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password, confirmPassword })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 400 && data.error.includes('expired')) {
                        document.getElementById('resetForm').style.display = 'none';
                        document.getElementById('invalidToken').style.display = 'block';
                        return;
                    }
                    throw new Error(data.error || 'Reset failed');
                }

                successMessage.innerHTML = 'Password reset successfully!<br>Redirecting to login...';
                successMessage.classList.add('show');
                document.getElementById('passwordForm').style.display = 'none';

                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
            } catch (error) {
                errorMessage.textContent = error.message;
                errorMessage.classList.add('show');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Reset Password';
            }
        });
    </script>
    <script src="/js/mobile-menu.js"></script>
    <!-- Live Ticker -->
    <script src="/js/live-ticker.js"></script>
</body>
</html>

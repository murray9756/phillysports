<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Curation | Admin | PhillySports.com</title>
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #8b0000; --dark-bg: #0a0a0a; --card-bg: #1a1a1a; --border-color: #333; --text-primary: #e8e8e8; --text-muted: #888; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
        a { color: var(--accent-color); text-decoration: none; }

        .admin-header { background: var(--card-bg); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .admin-header h1 { font-size: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .admin-nav { display: flex; gap: 1rem; }
        .admin-nav a { color: var(--text-muted); padding: 0.5rem 1rem; border-radius: 6px; transition: all 0.2s; }
        .admin-nav a:hover { color: var(--text-primary); background: rgba(255,255,255,0.05); }

        .main-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .add-btn { padding: 0.75rem 1.5rem; background: var(--accent-color); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .add-btn:hover { opacity: 0.9; }

        .filters { display: flex; gap: 1rem; flex-wrap: wrap; }
        .filter-select { padding: 0.5rem 1rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; }
        .filter-select:focus { outline: none; border-color: var(--accent-color); }

        .stats-bar { display: flex; gap: 2rem; padding: 1rem 1.5rem; background: var(--card-bg); border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); flex-wrap: wrap; }
        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .tickets-list { display: flex; flex-direction: column; gap: 1rem; }

        .ticket-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 1.25rem; display: grid; grid-template-columns: auto 1fr auto; gap: 1.5rem; align-items: center; }
        .ticket-card:hover { border-color: rgba(139, 0, 0, 0.5); }
        .ticket-card.sold { opacity: 0.6; border-color: #f44336; }
        .ticket-card.expired { opacity: 0.5; border-color: #666; }

        .ticket-status { width: 80px; text-align: center; }
        .status-badge { display: inline-block; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .status-badge.available { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
        .status-badge.sold { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .status-badge.expired { background: rgba(102, 102, 102, 0.2); color: #888; }

        .ticket-details { flex: 1; }
        .ticket-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .ticket-event { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .ticket-meta { display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.85rem; }
        .ticket-meta span { display: flex; align-items: center; gap: 0.35rem; }
        .ticket-meta .label { color: var(--text-muted); }

        .tier-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; margin-left: 0.5rem; }
        .tier-badge.lower_level { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
        .tier-badge.mid_level { background: rgba(100, 149, 237, 0.2); color: #6495ed; }
        .tier-badge.upper_level { background: rgba(169, 169, 169, 0.2); color: #a9a9a9; }
        .tier-badge.budget { background: rgba(76, 175, 80, 0.2); color: #4caf50; }

        .ticket-actions { display: flex; flex-direction: column; gap: 0.5rem; min-width: 140px; }
        .action-btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s; text-align: center; }
        .action-btn.primary { background: var(--accent-color); color: white; border: none; }
        .action-btn.primary:hover { opacity: 0.9; }
        .action-btn.secondary { background: transparent; border: 1px solid var(--border-color); color: var(--text-primary); }
        .action-btn.secondary:hover { border-color: var(--text-primary); }
        .action-btn.danger { background: transparent; border: 1px solid #f44336; color: #f44336; }
        .action-btn.danger:hover { background: rgba(244, 67, 54, 0.1); }

        /* Modal */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--card-bg); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.1rem; }
        .modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; line-height: 1; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 1rem; }

        .form-section { margin-bottom: 1.5rem; }
        .form-section h3 { font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.75rem; letter-spacing: 0.5px; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.35rem; }
        .form-group.full { grid-column: span 2; }
        .form-group label { font-size: 0.85rem; color: var(--text-muted); }
        .form-group input, .form-group select { padding: 0.65rem 0.85rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.95rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); }

        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        .spinner { display: inline-block; width: 30px; height: 30px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 3rem; color: var(--text-muted); }

        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 8px; color: white; font-weight: 500; z-index: 9999; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        .source-badge { font-size: 0.75rem; padding: 0.2rem 0.5rem; background: rgba(139, 0, 0, 0.2); color: var(--accent-color); border-radius: 4px; text-transform: capitalize; }

        /* Upcoming Games Section */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .section-header h2 { font-size: 1.1rem; color: var(--text-primary); }
        .section-header .refresh-btn { padding: 0.4rem 0.8rem; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer; }
        .section-header .refresh-btn:hover { border-color: var(--text-primary); color: var(--text-primary); }

        .games-section { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 1.25rem; margin-bottom: 2rem; }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .game-card { background: var(--dark-bg); border-radius: 8px; padding: 1rem; border: 1px solid var(--border-color); transition: all 0.2s; }
        .game-card:hover { border-color: rgba(139, 0, 0, 0.3); }
        .game-card .game-team { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .game-card .team-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .game-card .team-badge.eagles { background: #004C54; color: white; }
        .game-card .team-badge.phillies { background: #E81828; color: white; }
        .game-card .team-badge.sixers { background: #006BB6; color: white; }
        .game-card .team-badge.flyers { background: #F74902; color: white; }
        .game-card .game-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.35rem; }
        .game-card .game-datetime { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .game-card .game-venue { font-size: 0.8rem; color: var(--text-muted); }
        .game-card .add-tickets-hint { font-size: 0.75rem; color: var(--accent-color); margin-top: 0.75rem; padding: 0.4rem 0.75rem; background: rgba(139, 0, 0, 0.1); border: 1px solid var(--accent-color); border-radius: 4px; text-align: center; transition: all 0.15s; }
        .game-card .add-tickets-hint:hover { background: var(--accent-color); color: white; }
        .game-card .compare-links { display: flex; gap: 0.35rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .game-card .compare-link { padding: 0.3rem 0.5rem; font-size: 0.7rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-muted); text-decoration: none; transition: all 0.15s; }
        .game-card .compare-link:hover { border-color: var(--accent-color); color: var(--accent-color); }
        .game-card .compare-link.seatgeek:hover { border-color: #4caf50; color: #4caf50; }
        .game-card .compare-link.stubhub:hover { border-color: #3b5998; color: #3b5998; }
        .game-card .compare-link.ticketmaster:hover { border-color: #026cdf; color: #026cdf; }
        .game-card .compare-link.vivid:hover { border-color: #ff6b00; color: #ff6b00; }

        .games-loading, .games-empty { text-align: center; padding: 2rem; color: var(--text-muted); }
        .games-filter { display: flex; gap: 0.5rem; }
        .games-filter .filter-btn { padding: 0.35rem 0.75rem; background: transparent; border: 1px solid var(--border-color); border-radius: 4px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer; }
        .games-filter .filter-btn:hover { border-color: var(--text-primary); color: var(--text-primary); }
        .games-filter .filter-btn.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }

        @media (max-width: 768px) {
            .ticket-card { grid-template-columns: 1fr; gap: 1rem; }
            .ticket-actions { flex-direction: row; flex-wrap: wrap; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full { grid-column: span 1; }
        }
    </style>
    <link rel="stylesheet" href="/css/body-theme.css">
</head>
<body>
    <header class="admin-header">
        <h1>Ticket Curation</h1>
        <nav class="admin-nav">
            <a href="/admin.html">Dashboard</a>
            <a href="/marketplace/">View Marketplace</a>
        </nav>
    </header>

    <main class="main-container">
        <!-- Stats -->
        <div class="stats-bar" id="statsBar">
            <div class="stat">
                <div class="stat-value" id="availableCount">-</div>
                <div class="stat-label">Available</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="soldCount">-</div>
                <div class="stat-label">Sold</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="expiredCount">-</div>
                <div class="stat-label">Expired</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-label">Total</div>
            </div>
        </div>

        <!-- Upcoming Home Games -->
        <div class="games-section">
            <div class="section-header">
                <h2>Upcoming Home Games</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="games-filter">
                        <button class="filter-btn active" data-team="">All</button>
                        <button class="filter-btn" data-team="eagles">Eagles</button>
                        <button class="filter-btn" data-team="phillies">Phillies</button>
                        <button class="filter-btn" data-team="sixers">76ers</button>
                        <button class="filter-btn" data-team="flyers">Flyers</button>
                    </div>
                    <button class="refresh-btn" onclick="loadUpcomingGames()">Refresh</button>
                </div>
            </div>
            <div id="gamesGrid" class="games-grid">
                <div class="games-loading">Loading upcoming games...</div>
            </div>
        </div>

        <!-- Top Bar -->
        <div class="top-bar">
            <div class="filters">
                <select class="filter-select" id="teamFilter">
                    <option value="">All Teams</option>
                    <option value="eagles">Eagles</option>
                    <option value="phillies">Phillies</option>
                    <option value="sixers">76ers</option>
                    <option value="flyers">Flyers</option>
                </select>
                <select class="filter-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="available">Available</option>
                    <option value="sold">Sold</option>
                    <option value="expired">Expired</option>
                </select>
                <select class="filter-select" id="sourceFilter">
                    <option value="">All Sources</option>
                    <option value="seatgeek">SeatGeek</option>
                    <option value="stubhub">StubHub</option>
                    <option value="ticketmaster">Ticketmaster</option>
                    <option value="vividseats">Vivid Seats</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <button class="add-btn" onclick="openAddModal()">+ Add Ticket</button>
        </div>

        <!-- Tickets List -->
        <div class="tickets-list" id="ticketsList"></div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <p>No ticket listings found.</p>
            <p>Click "Add Ticket" to curate your first listing.</p>
        </div>

        <div class="loading" id="loadingState">
            <div class="spinner"></div>
            <p>Loading tickets...</p>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="ticketModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add Ticket Listing</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="ticketForm">
                    <input type="hidden" id="ticketId">

                    <div class="form-section">
                        <h3>Event Details</h3>
                        <div class="form-grid">
                            <div class="form-group full">
                                <label>Event Title *</label>
                                <input type="text" id="eventTitle" placeholder="Eagles vs Cowboys" required>
                            </div>
                            <div class="form-group">
                                <label>Event Date *</label>
                                <input type="date" id="eventDate" required>
                            </div>
                            <div class="form-group">
                                <label>Event Time *</label>
                                <input type="time" id="eventTime" required>
                            </div>
                            <div class="form-group">
                                <label>Venue *</label>
                                <input type="text" id="venue" placeholder="Lincoln Financial Field" required>
                            </div>
                            <div class="form-group">
                                <label>Team</label>
                                <select id="team">
                                    <option value="">Select team...</option>
                                    <option value="eagles">Eagles</option>
                                    <option value="phillies">Phillies</option>
                                    <option value="sixers">76ers</option>
                                    <option value="flyers">Flyers</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Ticket Details</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Section *</label>
                                <input type="text" id="section" placeholder="112" required>
                            </div>
                            <div class="form-group">
                                <label>Row</label>
                                <input type="text" id="row" placeholder="8">
                            </div>
                            <div class="form-group">
                                <label>Quantity *</label>
                                <input type="number" id="quantity" min="1" value="2" required>
                            </div>
                            <div class="form-group">
                                <label>Price Per Ticket ($) *</label>
                                <input type="number" id="pricePerTicket" min="1" step="0.01" placeholder="285.00" required>
                            </div>
                            <div class="form-group full">
                                <label>Tier</label>
                                <select id="tier">
                                    <option value="lower_level">Lower Level</option>
                                    <option value="mid_level" selected>Mid Level</option>
                                    <option value="upper_level">Upper Level</option>
                                    <option value="budget">Budget Pick</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Source</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Platform *</label>
                                <select id="source" required>
                                    <option value="seatgeek">SeatGeek</option>
                                    <option value="stubhub">StubHub</option>
                                    <option value="ticketmaster">Ticketmaster</option>
                                    <option value="vividseats">Vivid Seats</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group full">
                                <label>Listing URL *</label>
                                <input type="url" id="sourceUrl" placeholder="https://seatgeek.com/..." required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="action-btn secondary" onclick="closeModal()">Cancel</button>
                <button class="action-btn primary" onclick="saveTicket()">Save Ticket</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let tickets = [];
        let upcomingGames = [];
        let editingId = null;
        let gamesTeamFilter = '';

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Load tickets
        async function loadTickets() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('ticketsList').innerHTML = '';
            document.getElementById('emptyState').style.display = 'none';

            try {
                const team = document.getElementById('teamFilter').value;
                const status = document.getElementById('statusFilter').value;
                const source = document.getElementById('sourceFilter').value;

                const params = new URLSearchParams();
                if (team) params.append('team', team);
                if (status) params.append('status', status);
                if (source) params.append('source', source);

                const response = await fetch('/api/admin/tickets?' + params);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load tickets');
                }

                tickets = data.tickets;
                renderTickets();
                updateStats();
            } catch (error) {
                console.error('Load error:', error);
                showToast(error.message, 'error');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        // Load upcoming games from ESPN API
        async function loadUpcomingGames() {
            const grid = document.getElementById('gamesGrid');
            grid.innerHTML = '<div class="games-loading">Loading upcoming games...</div>';

            try {
                const params = new URLSearchParams({ days: 60 });
                if (gamesTeamFilter) params.set('team', gamesTeamFilter);

                const response = await fetch('/api/schedules/philly?' + params);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load games');
                }

                upcomingGames = data.games;
                renderUpcomingGames();
            } catch (error) {
                console.error('Load games error:', error);
                grid.innerHTML = '<div class="games-empty">Failed to load games. <a href="#" onclick="loadUpcomingGames(); return false;">Try again</a></div>';
            }
        }

        // Render upcoming games
        function renderUpcomingGames() {
            const grid = document.getElementById('gamesGrid');

            if (upcomingGames.length === 0) {
                grid.innerHTML = '<div class="games-empty">No upcoming home games found.</div>';
                return;
            }

            grid.innerHTML = upcomingGames.map(game => {
                const gameDate = new Date(game.date);
                const dateStr = gameDate.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
                const timeStr = gameDate.toLocaleTimeString('en-US', {
                    hour: 'numeric', minute: '2-digit'
                });

                // Build search query for ticket sites
                const searchQuery = encodeURIComponent(game.eventTitle);
                const dateQuery = gameDate.toISOString().split('T')[0];

                return `
                    <div class="game-card">
                        <div class="game-team">
                            <span class="team-badge ${game.team}">${game.teamName}</span>
                            ${game.seasonType !== 'Regular Season' ? `<span style="font-size: 0.7rem; color: #ffd700;">${game.seasonType}</span>` : ''}
                        </div>
                        <div class="game-title">${game.eventTitle}</div>
                        <div class="game-datetime">${dateStr} @ ${timeStr}</div>
                        <div class="game-venue">${game.venue}</div>
                        <div class="compare-links">
                            <a href="https://seatgeek.com/search?q=${searchQuery}" target="_blank" class="compare-link seatgeek" onclick="event.stopPropagation()">SeatGeek</a>
                            <a href="https://www.stubhub.com/find/s/?q=${searchQuery}" target="_blank" class="compare-link stubhub" onclick="event.stopPropagation()">StubHub</a>
                            <a href="https://www.ticketmaster.com/search?q=${searchQuery}" target="_blank" class="compare-link ticketmaster" onclick="event.stopPropagation()">Ticketmaster</a>
                            <a href="https://www.vividseats.com/search?searchTerm=${searchQuery}" target="_blank" class="compare-link vivid" onclick="event.stopPropagation()">Vivid</a>
                        </div>
                        <div class="add-tickets-hint" style="cursor: pointer;" onclick="prefillFromGame('${encodeURIComponent(JSON.stringify(game))}')">+ Add Ticket Listing</div>
                    </div>
                `;
            }).join('');
        }

        // Prefill form from game data
        function prefillFromGame(encodedGame) {
            const game = JSON.parse(decodeURIComponent(encodedGame));
            const gameDate = new Date(game.date);

            // Reset form and open modal
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Ticket Listing';
            document.getElementById('ticketForm').reset();
            document.getElementById('ticketId').value = '';

            // Prefill event details
            document.getElementById('eventTitle').value = game.eventTitle;
            document.getElementById('eventDate').value = gameDate.toISOString().split('T')[0];
            document.getElementById('eventTime').value = gameDate.toTimeString().slice(0, 5);
            document.getElementById('venue').value = game.venue;
            document.getElementById('team').value = game.team;

            // Open modal
            document.getElementById('ticketModal').classList.add('show');
        }

        // Games filter handlers
        document.querySelectorAll('.games-filter .filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.games-filter .filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                gamesTeamFilter = btn.dataset.team;
                loadUpcomingGames();
            });
        });

        // Render tickets
        function renderTickets() {
            const list = document.getElementById('ticketsList');

            if (tickets.length === 0) {
                list.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';

            list.innerHTML = tickets.map(ticket => {
                const td = ticket.ticketData;
                const eventDate = new Date(td.eventDate);
                const dateStr = eventDate.toLocaleDateString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric'
                });
                const timeStr = eventDate.toLocaleTimeString('en-US', {
                    hour: 'numeric', minute: '2-digit'
                });

                const tierLabels = {
                    lower_level: 'Lower Level',
                    mid_level: 'Mid Level',
                    upper_level: 'Upper Level',
                    budget: 'Budget'
                };

                const isExpired = eventDate < new Date();
                const statusClass = isExpired ? 'expired' : td.status;
                const statusLabel = isExpired ? 'Expired' : (td.status === 'available' ? 'Available' : 'Sold');

                return `
                    <div class="ticket-card ${statusClass}">
                        <div class="ticket-status">
                            <span class="status-badge ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="ticket-details">
                            <div class="ticket-title">
                                ${ticket.name}
                                <span class="tier-badge ${td.tier}">${tierLabels[td.tier] || td.tier}</span>
                            </div>
                            <div class="ticket-event">${dateStr} @ ${timeStr} - ${td.venue}</div>
                            <div class="ticket-meta">
                                <span><span class="label">Qty:</span> ${td.quantity}</span>
                                <span><span class="label">Price:</span> $${(td.pricePerTicket / 100).toFixed(0)}/ea</span>
                                <span><span class="source-badge">${td.source}</span></span>
                                ${ticket.team ? `<span class="label">${ticket.team.charAt(0).toUpperCase() + ticket.team.slice(1)}</span>` : ''}
                            </div>
                        </div>
                        <div class="ticket-actions">
                            <a href="${td.sourceUrl}" target="_blank" class="action-btn secondary">View Source</a>
                            <button class="action-btn secondary" onclick="editTicket('${ticket._id}')">Edit</button>
                            ${td.status === 'available' && !isExpired ? `
                                <button class="action-btn danger" onclick="markSold('${ticket._id}')">Mark Sold</button>
                            ` : ''}
                            <button class="action-btn danger" onclick="deleteTicket('${ticket._id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update stats
        function updateStats() {
            const available = tickets.filter(t => t.ticketData.status === 'available' && new Date(t.ticketData.eventDate) > new Date()).length;
            const sold = tickets.filter(t => t.ticketData.status === 'sold').length;
            const expired = tickets.filter(t => new Date(t.ticketData.eventDate) < new Date() || t.ticketData.status === 'expired').length;

            document.getElementById('availableCount').textContent = available;
            document.getElementById('soldCount').textContent = sold;
            document.getElementById('expiredCount').textContent = expired;
            document.getElementById('totalCount').textContent = tickets.length;
        }

        // Open add modal
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Ticket Listing';
            document.getElementById('ticketForm').reset();
            document.getElementById('ticketId').value = '';
            document.getElementById('ticketModal').classList.add('show');
        }

        // Edit ticket
        function editTicket(id) {
            const ticket = tickets.find(t => t._id === id);
            if (!ticket) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Ticket Listing';
            document.getElementById('ticketId').value = id;

            const td = ticket.ticketData;
            const eventDate = new Date(td.eventDate);

            document.getElementById('eventTitle').value = td.eventTitle;
            document.getElementById('eventDate').value = eventDate.toISOString().split('T')[0];
            document.getElementById('eventTime').value = eventDate.toTimeString().slice(0, 5);
            document.getElementById('venue').value = td.venue;
            document.getElementById('team').value = ticket.team || '';
            document.getElementById('section').value = td.section;
            document.getElementById('row').value = td.row || '';
            document.getElementById('quantity').value = td.quantity;
            document.getElementById('pricePerTicket').value = (td.pricePerTicket / 100).toFixed(2);
            document.getElementById('tier').value = td.tier;
            document.getElementById('source').value = td.source;
            document.getElementById('sourceUrl').value = td.sourceUrl;

            document.getElementById('ticketModal').classList.add('show');
        }

        // Close modal
        function closeModal() {
            document.getElementById('ticketModal').classList.remove('show');
            editingId = null;
        }

        // Save ticket
        async function saveTicket() {
            const form = document.getElementById('ticketForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const eventDateStr = document.getElementById('eventDate').value;
            const eventTimeStr = document.getElementById('eventTime').value;
            const eventDate = new Date(`${eventDateStr}T${eventTimeStr}`);

            const ticketData = {
                eventTitle: document.getElementById('eventTitle').value,
                eventDate: eventDate.toISOString(),
                venue: document.getElementById('venue').value,
                team: document.getElementById('team').value || null,
                section: document.getElementById('section').value,
                row: document.getElementById('row').value || null,
                quantity: parseInt(document.getElementById('quantity').value),
                pricePerTicket: parseFloat(document.getElementById('pricePerTicket').value),
                tier: document.getElementById('tier').value,
                source: document.getElementById('source').value,
                sourceUrl: document.getElementById('sourceUrl').value
            };

            try {
                let response;
                if (editingId) {
                    response = await fetch(`/api/admin/tickets/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ticketData)
                    });
                } else {
                    response = await fetch('/api/admin/tickets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(ticketData)
                    });
                }

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to save ticket');
                }

                showToast(editingId ? 'Ticket updated!' : 'Ticket added!');
                closeModal();
                loadTickets();
            } catch (error) {
                console.error('Save error:', error);
                showToast(error.message, 'error');
            }
        }

        // Mark as sold
        async function markSold(id) {
            if (!confirm('Mark this ticket as sold?')) return;

            try {
                const response = await fetch(`/api/admin/tickets/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticketStatus: 'sold' })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to update ticket');
                }

                showToast('Ticket marked as sold');
                loadTickets();
            } catch (error) {
                console.error('Update error:', error);
                showToast(error.message, 'error');
            }
        }

        // Delete ticket
        async function deleteTicket(id) {
            if (!confirm('Delete this ticket listing?')) return;

            try {
                const response = await fetch(`/api/admin/tickets/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to delete ticket');
                }

                showToast('Ticket deleted');
                loadTickets();
            } catch (error) {
                console.error('Delete error:', error);
                showToast(error.message, 'error');
            }
        }

        // Filter change handlers
        document.getElementById('teamFilter').addEventListener('change', loadTickets);
        document.getElementById('statusFilter').addEventListener('change', loadTickets);
        document.getElementById('sourceFilter').addEventListener('change', loadTickets);

        // Close modal on outside click
        document.getElementById('ticketModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('ticketModal')) {
                closeModal();
            }
        });

        // Initialize
        loadTickets();
        loadUpcomingGames();
    </script>
    <!-- Shared Footer -->
    <div id="site-footer"></div>
    <script src="/js/footer.js"></script>
</body>
</html>

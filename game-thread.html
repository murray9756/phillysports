<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KRBRNKNC97"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KRBRNKNC97');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Thread - PhillySports.com</title>
    <meta name="description" content="Live game thread discussion for Philadelphia sports teams.">
    <link rel="icon" type="image/png" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        :root {
            --eagles-green: #004C54;
            --phillies-red: #E81828;
            --sixers-blue: #006BB6;
            --flyers-orange: #F74902;
            --dark-bg: #faf9f6;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1a1a1a;
            --text-secondary: #555555;
            --text-muted: #888888;
            --header-bg: #faf9f6;
            --nav-text: #333333;
            --accent-color: #8b0000;
            --widget-header-bg: #e8e3db;
        }

        [data-theme="dark"] {
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --border-color: #333333;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --header-bg: #1a1a1a;
            --nav-text: #d0d0d0;
            --widget-header-bg: #2a2a2a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; }
        a { color: inherit; text-decoration: none; }

        .header { background: var(--header-bg); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000; }
        .header-top { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.5rem; max-width: 1400px; margin: 0 auto; }
        .header-logo { display: flex; align-items: center; gap: 0.5rem; }
        .header-logo img { width: 40px; height: 40px; border-radius: 6px; }
        .header-logo span { font-weight: 700; font-size: 1.1rem; color: var(--text-primary); }

        .header-auth { display: flex; align-items: center; gap: 1rem; }
        .header-auth a { color: var(--nav-text); font-size: 0.85rem; font-weight: 500; padding: 0.5rem 0.75rem; border-radius: 4px; transition: background 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-auth a:hover { background: rgba(0,0,0,0.05); }
        .coin-display { display: flex; align-items: center; gap: 0.35rem; background: rgba(139,0,0,0.1); padding: 0.35rem 0.75rem; border-radius: 20px; font-weight: 600; font-size: 0.85rem; color: var(--accent-color); }

        /* Dark Mode Toggle */
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 0.4rem 0.6rem;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .theme-toggle:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .theme-toggle:hover { background: rgba(255,255,255,0.1); }
        .theme-toggle .theme-icon-light, .theme-toggle .theme-icon-dark { display: none; }
        .theme-toggle .theme-icon-light { display: inline; }
        [data-theme="dark"] .theme-toggle .theme-icon-light { display: none; }
        [data-theme="dark"] .theme-toggle .theme-icon-dark { display: inline; }

        .header-nav { display: flex; align-items: center; justify-content: center; gap: 0.25rem; padding: 0.5rem 1.5rem; max-width: 1400px; margin: 0 auto; flex-wrap: wrap; border-top: 1px solid var(--border-color); }
        .header-nav a { color: var(--nav-text); font-size: 0.8rem; font-weight: 600; padding: 0.4rem 0.75rem; border-radius: 4px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .header-nav a:hover { background: rgba(0,0,0,0.05); color: var(--accent-color); }
        .header-nav a.active { color: var(--accent-color); }
        .nav-separator { color: var(--border-color); margin: 0 0.25rem; }

        .main-container { max-width: 900px; margin: 0 auto; padding: 1.5rem; }

        /* Game Header */
        .game-header {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .game-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 1rem;
        }
        .game-status.pre-game { background: var(--text-muted); color: #fff; }
        .game-status.live { background: #e74c3c; color: #fff; animation: pulse 2s infinite; }
        .game-status.post-game { background: var(--text-secondary); color: #fff; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .game-teams {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin-bottom: 1rem;
        }

        .team {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .team-emoji { font-size: 3rem; }
        .team-name { font-size: 1rem; font-weight: 600; }
        .team-score { font-size: 2.5rem; font-weight: 800; }

        .game-vs {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-muted);
        }

        .game-period {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Reactions Bar */
        .reactions-bar {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .reaction-btn {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0.75rem;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .reaction-btn:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .reaction-btn span { font-size: 0.8rem; color: var(--text-muted); }

        /* Chat Section */
        .chat-section {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .chat-header {
            padding: 0.75rem 1rem;
            background: var(--widget-header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .chat-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .message-username {
            font-weight: 600;
            font-size: 0.85rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .message-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            word-break: break-word;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input-area input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--dark-bg);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .chat-input-area input::placeholder {
            color: var(--text-muted);
        }

        .chat-input-area button {
            padding: 0.75rem 1.25rem;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: opacity 0.2s;
        }

        .chat-input-area button:hover {
            opacity: 0.9;
        }

        .chat-input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .login-prompt {
            padding: 1rem;
            text-align: center;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
        }

        .login-prompt a {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #e74c3c;
        }

        /* Team colors */
        .team-eagles .team-score { color: var(--eagles-green); }
        .team-phillies .team-score { color: var(--phillies-red); }
        .team-sixers .team-score { color: var(--sixers-blue); }
        .team-flyers .team-score { color: var(--flyers-orange); }

        /* Vote Controls */
        .vote-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.1rem;
            margin-right: 0.5rem;
        }
        .vote-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            padding: 0.1rem 0.25rem;
            line-height: 1;
            transition: all 0.2s;
        }
        .vote-btn:hover { color: var(--text-primary); }
        .vote-btn.upvote.active { color: #ff4500; }
        .vote-btn.downvote.active { color: #7193ff; }
        .vote-score {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Mentions */
        .mention {
            color: var(--sixers-blue);
            font-weight: 500;
            cursor: pointer;
        }
        .mention:hover { text-decoration: underline; }

        /* Mention Autocomplete */
        .mention-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .mention-dropdown.show { display: block; }
        .mention-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
        }
        .mention-item:hover, .mention-item.selected { background: var(--dark-bg); }
        .mention-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .mention-name { font-size: 0.85rem; font-weight: 500; }
        .mention-username { font-size: 0.75rem; color: var(--text-muted); }

        .chat-input-wrapper {
            position: relative;
            flex: 1;
        }

        @media (max-width: 600px) {
            .game-teams { gap: 1rem; }
            .team-emoji { font-size: 2rem; }
            .team-score { font-size: 2rem; }
            .chat-messages { height: 300px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <a href="/" class="header-logo">
                <img src="/logo-weathered.png" alt="PhillySports.com">
                <span>PhillySports.com</span>
            </a>
            <div class="header-auth" id="authSection">
                <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                    <span class="theme-icon-light">&#9790;</span>
                    <span class="theme-icon-dark">&#9728;</span>
                </button>
                <a href="/login.html">Login</a>
                <a href="/register.html">Register</a>
            </div>
        </div>
        <nav class="header-nav">
            <a href="/">Home</a>
            <span class="nav-separator">|</span>
            <a href="/eagles/">Eagles</a>
            <span class="nav-separator">|</span>
            <a href="/phillies/">Phillies</a>
            <span class="nav-separator">|</span>
            <a href="/sixers/">Sixers</a>
            <span class="nav-separator">|</span>
            <a href="/flyers/">Flyers</a>
            <span class="nav-separator">|</span>
            <a href="/esports" class="team-tab" data-team="esports">eSports</a>
            <span class="nav-separator">|</span>
            <a href="/trivia.html">Trivia</a>
            <span class="nav-separator">|</span>
            <a href="/odds.html">Odds</a>
            <span class="nav-separator">|</span>
            <a href="/bets.html">Bets</a>
            <span class="nav-separator">|</span>
            <a href="/poker.html">Poker</a>
            <span class="nav-separator">|</span>
            <a href="/fantasy.html">Fantasy</a>
            <span class="nav-separator">|</span>
            <a href="/pools.html">Pools</a>
            <span class="nav-separator">|</span>
            <a href="/community/" class="active">Community</a>
            <span class="nav-separator">|</span>
            <a href="/badges.html">Badges</a>
            <span class="nav-separator">|</span>
            <a href="/shop.html">Shop</a>
        </nav>
    </header>

    <main class="main-container">
        <div id="content">
            <div class="loading">Loading game thread...</div>
        </div>
    </main>

    <script>
        // Dark Mode
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        initTheme();
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        // State
        let currentUser = null;
        let thread = null;
        let pusher = null;
        let channel = null;
        let userVotes = {};
        let mentionUsers = [];
        let mentionIndex = -1;

        const teamEmojis = {
            eagles: 'ü¶Ö',
            phillies: '‚öæ',
            sixers: 'üèÄ',
            flyers: 'üèí'
        };

        // Get thread ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const threadId = urlParams.get('id');

        // Check auth
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    document.getElementById('authSection').innerHTML = `
                        <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                            <span class="theme-icon-light">&#9790;</span>
                            <span class="theme-icon-dark">&#9728;</span>
                        </button>
                        <div class="coin-display">
                            <span>ü™ô</span>
                            <span>${Math.round(currentUser.coinBalance || 0)}</span>
                        </div>
                        <a href="/profile.html">${currentUser.displayName || currentUser.username}</a>
                        <a href="#" onclick="logout(); return false;">Logout</a>
                    `;
                    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
                }
            } catch (e) {}
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
            window.location.reload();
        }

        // Load thread
        async function loadThread() {
            if (!threadId) {
                document.getElementById('content').innerHTML = '<div class="error">No thread ID provided</div>';
                return;
            }

            try {
                const response = await fetch(`/api/game-threads/${threadId}`);
                const data = await response.json();

                if (!data.success) {
                    document.getElementById('content').innerHTML = `<div class="error">${data.error || 'Thread not found'}</div>`;
                    return;
                }

                thread = data.thread;
                document.title = `${thread.title} - PhillySports.com`;

                renderThread(data.thread, data.comments);

                // Setup Pusher
                if (data.pusherKey && data.pusherCluster) {
                    setupPusher(data.pusherKey, data.pusherCluster, thread.pusherChannel);
                }

                // Start polling for score updates (backup to Pusher)
                if (thread.status === 'live' || thread.status === 'pre-game') {
                    setInterval(refreshScore, 30000);
                }
            } catch (error) {
                console.error('Load thread error:', error);
                document.getElementById('content').innerHTML = '<div class="error">Failed to load thread</div>';
            }
        }

        function renderThread(thread, comments) {
            const isHome = thread.isHome;
            const phillyTeam = thread.team;
            const phillyEmoji = teamEmojis[phillyTeam] || 'üèà';

            const homeScore = thread.currentScore?.home || 0;
            const awayScore = thread.currentScore?.away || 0;
            const period = thread.currentScore?.period || 'Pre-game';

            const html = `
                <div class="game-header">
                    <span class="game-status ${thread.status}">${thread.status.replace('-', ' ')}</span>
                    <div class="game-teams">
                        <div class="team ${isHome ? 'team-' + phillyTeam : ''}">
                            <span class="team-name">${thread.homeTeam}</span>
                            <span class="team-score" id="homeScore">${homeScore}</span>
                        </div>
                        <span class="game-vs">@</span>
                        <div class="team ${!isHome ? 'team-' + phillyTeam : ''}">
                            <span class="team-name">${thread.awayTeam}</span>
                            <span class="team-score" id="awayScore">${awayScore}</span>
                        </div>
                    </div>
                    <div class="game-period" id="gamePeriod">${period}</div>
                    <div class="reactions-bar">
                        <button class="reaction-btn" onclick="react('fire')">üî• <span id="react-fire">${thread.reactions?.fire || 0}</span></button>
                        <button class="reaction-btn" onclick="react('celebrate')">üéâ <span id="react-celebrate">${thread.reactions?.celebrate || 0}</span></button>
                        <button class="reaction-btn" onclick="react('angry')">üò§ <span id="react-angry">${thread.reactions?.angry || 0}</span></button>
                        <button class="reaction-btn" onclick="react('skull')">üíÄ <span id="react-skull">${thread.reactions?.skull || 0}</span></button>
                    </div>
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <span class="chat-title">üí¨ Live Chat</span>
                        <span class="chat-count" id="commentCount">${thread.commentCount || 0} comments</span>
                    </div>
                    <div class="chat-messages" id="chatMessages">
                        ${comments.map(c => renderComment(c)).join('')}
                    </div>
                    ${currentUser ? `
                        <div class="chat-input-area">
                            <div class="chat-input-wrapper">
                                <div class="mention-dropdown" id="mentionDropdown"></div>
                                <input type="text" id="commentInput" placeholder="Say something... (use @username to mention)" maxlength="500">
                            </div>
                            <button onclick="postComment()" id="sendBtn">Send</button>
                        </div>
                    ` : `
                        <div class="login-prompt">
                            <a href="/login.html">Log in</a> to join the conversation
                        </div>
                    `}
                </div>
            `;

            document.getElementById('content').innerHTML = html;

            // Scroll to bottom of chat
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Enter key to send (only when mention dropdown is not showing)
            const input = document.getElementById('commentInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    const dropdown = document.getElementById('mentionDropdown');
                    if (e.key === 'Enter' && (!dropdown || !dropdown.classList.contains('show') || mentionIndex < 0)) {
                        postComment();
                    }
                });

                // Setup mention autocomplete
                setupMentionAutocomplete();
            }

            // Load user votes if logged in
            if (currentUser && comments.length > 0) {
                loadUserVotes(comments.map(c => c._id));
            }
        }

        async function loadUserVotes(commentIds) {
            try {
                const response = await fetch(`/api/votes?contentType=game_thread_comment&contentIds=${commentIds.join(',')}`, {
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    Object.keys(data.votes).forEach(id => {
                        userVotes[id] = data.votes[id].userVote;
                    });
                }
            } catch (error) {
                console.error('Load votes error:', error);
            }
        }

        function renderComment(comment) {
            const initial = (comment.username || 'A')[0].toUpperCase();
            const time = new Date(comment.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const score = comment.score || 0;
            const commentId = comment._id;
            const userVote = userVotes[commentId] || 0;

            return `
                <div class="chat-message" data-comment-id="${commentId}">
                    <div class="vote-controls">
                        <button class="vote-btn upvote ${userVote === 1 ? 'active' : ''}" onclick="vote('${commentId}', 1)">‚ñ≤</button>
                        <span class="vote-score" id="score-${commentId}">${score}</span>
                        <button class="vote-btn downvote ${userVote === -1 ? 'active' : ''}" onclick="vote('${commentId}', -1)">‚ñº</button>
                    </div>
                    <div class="message-avatar">${initial}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <a href="/profile.html?username=${comment.username}" class="message-username">${comment.username}</a>
                            <span class="message-time">${time}</span>
                        </div>
                        <div class="message-text">${renderWithMentions(escapeHtml(comment.content))}</div>
                    </div>
                </div>
            `;
        }

        function renderWithMentions(content) {
            return content.replace(/@(\w+)/g, '<a href="/profile.html?username=$1" class="mention">@$1</a>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function postComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if (!content) return;

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;

            try {
                const response = await fetch(`/api/game-threads/${threadId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ content })
                });

                const data = await response.json();
                if (data.success) {
                    input.value = '';
                    // Comment will appear via Pusher
                }
            } catch (error) {
                console.error('Post comment error:', error);
            }

            btn.disabled = false;
        }

        async function react(reaction) {
            try {
                await fetch(`/api/game-threads/${threadId}/react`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ reaction })
                });
                // Reaction count will update via Pusher
            } catch (error) {
                console.error('React error:', error);
            }
        }

        // Voting
        async function vote(commentId, voteValue) {
            if (!currentUser) {
                window.location.href = '/login.html';
                return;
            }

            const currentVote = userVotes[commentId] || 0;
            const newVote = currentVote === voteValue ? 0 : voteValue;

            try {
                const response = await fetch('/api/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        contentType: 'game_thread_comment',
                        contentId: commentId,
                        vote: newVote
                    })
                });

                const data = await response.json();
                if (data.success) {
                    userVotes[commentId] = data.userVote;

                    // Update score display
                    const scoreEl = document.getElementById(`score-${commentId}`);
                    if (scoreEl) scoreEl.textContent = data.score;

                    // Update button states
                    const messageEl = document.querySelector(`[data-comment-id="${commentId}"]`);
                    if (messageEl) {
                        const upBtn = messageEl.querySelector('.upvote');
                        const downBtn = messageEl.querySelector('.downvote');
                        upBtn.classList.toggle('active', data.userVote === 1);
                        downBtn.classList.toggle('active', data.userVote === -1);
                    }
                }
            } catch (error) {
                console.error('Vote error:', error);
            }
        }

        // Mention autocomplete
        async function searchMentions(query) {
            if (query.length < 1) {
                hideMentionDropdown();
                return;
            }

            try {
                const response = await fetch(`/api/mentions/search?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();

                if (data.success && data.users.length > 0) {
                    mentionUsers = data.users;
                    mentionIndex = -1;
                    showMentionDropdown(data.users);
                } else {
                    hideMentionDropdown();
                }
            } catch (error) {
                console.error('Search mentions error:', error);
                hideMentionDropdown();
            }
        }

        function showMentionDropdown(users) {
            const dropdown = document.getElementById('mentionDropdown');
            if (!dropdown) return;

            dropdown.innerHTML = users.map((user, index) => `
                <div class="mention-item ${index === mentionIndex ? 'selected' : ''}" onclick="selectMention('${user.username}')">
                    <div class="mention-avatar-small">${(user.displayName || user.username)[0].toUpperCase()}</div>
                    <div>
                        <div class="mention-name">${user.displayName || user.username}</div>
                        <div class="mention-username">@${user.username}</div>
                    </div>
                </div>
            `).join('');
            dropdown.classList.add('show');
        }

        function hideMentionDropdown() {
            const dropdown = document.getElementById('mentionDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
                mentionUsers = [];
                mentionIndex = -1;
            }
        }

        function selectMention(username) {
            const input = document.getElementById('commentInput');
            if (!input) return;

            const value = input.value;
            const cursorPos = input.selectionStart;

            // Find the @ symbol before cursor
            let atIndex = value.lastIndexOf('@', cursorPos - 1);
            if (atIndex !== -1) {
                const before = value.substring(0, atIndex);
                const after = value.substring(cursorPos);
                input.value = before + '@' + username + ' ' + after;
                const newPos = atIndex + username.length + 2;
                input.setSelectionRange(newPos, newPos);
            }

            hideMentionDropdown();
            input.focus();
        }

        function setupMentionAutocomplete() {
            const input = document.getElementById('commentInput');
            if (!input) return;

            let debounceTimer;

            input.addEventListener('input', (e) => {
                const value = e.target.value;
                const cursorPos = e.target.selectionStart;

                // Find @ before cursor
                const beforeCursor = value.substring(0, cursorPos);
                const atMatch = beforeCursor.match(/@(\w*)$/);

                if (atMatch) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => searchMentions(atMatch[1]), 200);
                } else {
                    hideMentionDropdown();
                }
            });

            input.addEventListener('keydown', (e) => {
                const dropdown = document.getElementById('mentionDropdown');
                if (!dropdown || !dropdown.classList.contains('show')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    mentionIndex = Math.min(mentionIndex + 1, mentionUsers.length - 1);
                    showMentionDropdown(mentionUsers);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    mentionIndex = Math.max(mentionIndex - 1, 0);
                    showMentionDropdown(mentionUsers);
                } else if (e.key === 'Enter' && mentionIndex >= 0) {
                    e.preventDefault();
                    selectMention(mentionUsers[mentionIndex].username);
                } else if (e.key === 'Escape') {
                    hideMentionDropdown();
                }
            });
        }

        function setupPusher(key, cluster, channelName) {
            pusher = new Pusher(key, { cluster });
            channel = pusher.subscribe(channelName);

            channel.bind('new-comment', (data) => {
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.insertAdjacentHTML('beforeend', renderComment(data));
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Update count
                const countEl = document.getElementById('commentCount');
                const currentCount = parseInt(countEl.textContent) || 0;
                countEl.textContent = `${currentCount + 1} comments`;
            });

            channel.bind('score-update', (data) => {
                document.getElementById('homeScore').textContent = data.home;
                document.getElementById('awayScore').textContent = data.away;
                document.getElementById('gamePeriod').textContent = data.period;
            });

            channel.bind('reaction', (data) => {
                if (data.reactions) {
                    Object.keys(data.reactions).forEach(key => {
                        const el = document.getElementById(`react-${key}`);
                        if (el) el.textContent = data.reactions[key];
                    });
                }
            });

            channel.bind('status-change', (data) => {
                const statusEl = document.querySelector('.game-status');
                if (statusEl) {
                    statusEl.className = `game-status ${data.status}`;
                    statusEl.textContent = data.status.replace('-', ' ');
                }
            });
        }

        async function refreshScore() {
            try {
                const response = await fetch(`/api/game-threads/${threadId}`);
                const data = await response.json();
                if (data.success && data.thread.currentScore) {
                    document.getElementById('homeScore').textContent = data.thread.currentScore.home;
                    document.getElementById('awayScore').textContent = data.thread.currentScore.away;
                    document.getElementById('gamePeriod').textContent = data.thread.currentScore.period;
                }
            } catch (e) {}
        }

        // Init
        checkAuth().then(loadThread);
    </script>
    <!-- Live Ticker -->
    <script src="/js/live-ticker.js"></script>
</body>
</html>

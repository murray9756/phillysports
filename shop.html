<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics (excludes admin users) -->
    <script>
    if (localStorage.getItem('isAdmin') !== 'true') {
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id=G-KRBRNKNC97';
        document.head.appendChild(s);
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KRBRNKNC97');
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diehard Dollars Shop | PhillySports.com</title>
    <meta name="description" content="Spend your Diehard Dollars on badges and exclusive items.">
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="manifest" href="/public/manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #8b0000; --dark-bg: #faf9f6; --card-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1a1a1a; --text-secondary: #555555; --text-muted: #888888; --nav-text: #333333; --widget-header-bg: #e8e3db; }
        [data-theme="dark"] {
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --card-bg-hover: #2a2a2a;
            --border-color: #333333;
            --text-primary: #e8e8e8;
            --text-secondary: #b0b0b0;
            --text-muted: #808080;
            --nav-text: #d0d0d0;
            --widget-header-bg: #2a2a2a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--dark-bg); color: var(--text-primary); line-height: 1.6; }
        a { color: inherit; text-decoration: none; }
        /* Feedback Modal */
        .feedback-btn { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 0.35rem 0.6rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .feedback-btn:hover { background: var(--accent-color); color: white; border-color: var(--accent-color); }
        .feedback-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 10000; }
        .feedback-modal-overlay.active { display: flex; }
        .feedback-modal { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 450px; max-height: 90vh; overflow-y: auto; position: relative; }
        .feedback-modal h3 { margin: 0 0 1rem 0; color: var(--accent-color); }
        .feedback-modal-close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted); }
        .feedback-type-group { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .feedback-type-option { flex: 1; display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .feedback-type-option:hover { border-color: var(--accent-color); }
        .feedback-type-option.selected { border-color: var(--accent-color); background: rgba(139, 0, 0, 0.1); }
        .feedback-type-option input { display: none; }
        .feedback-textarea { width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-color); font-family: inherit; font-size: 0.9rem; resize: vertical; margin-bottom: 1rem; }
        .feedback-textarea:focus { outline: none; border-color: var(--accent-color); }
        .feedback-submit { width: 100%; padding: 0.75rem; background: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .feedback-submit:hover { opacity: 0.9; }
        .feedback-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .feedback-reward { text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-top: 0.75rem; }
        .feedback-reward span { color: #b8860b; font-weight: 600; }
        .feedback-success { text-align: center; padding: 1rem; }
        .feedback-success h4 { color: #28a745; margin: 0 0 0.5rem 0; }
        .page-hero { background: linear-gradient(135deg, #ffd700, #ff9800); padding: 2rem 1.5rem; text-align: center; color: #1a1a1a; }
        .page-hero h1 { font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .page-hero p { font-size: 1rem; opacity: 0.8; }
        .balance-display { background: rgba(0,0,0,0.1); padding: 0.75rem 1.5rem; border-radius: 25px; display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; font-size: 1.25rem; font-weight: 700; }
        .main-container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        .shop-section { margin-bottom: 2rem; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; }
        .section-title { font-size: 1.1rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); }
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .badge-card { background: var(--card-bg); border-radius: 12px; border: 2px solid var(--border-color); padding: 1.25rem; transition: all 0.2s; position: relative; overflow: hidden; }
        .badge-card:hover { border-color: var(--accent-color); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .badge-card.owned { border-color: #4caf50; background: linear-gradient(135deg, #e8f5e9, #ffffff); }
        .badge-card.owned::after { content: 'OWNED'; position: absolute; top: 10px; right: -30px; background: #4caf50; color: white; padding: 0.25rem 2rem; font-size: 0.65rem; font-weight: 700; transform: rotate(45deg); }
        .badge-card.earned-only { border-style: dashed; opacity: 0.7; }
        .badge-icon { font-size: 3rem; margin-bottom: 0.75rem; }
        .badge-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; }
        .badge-description { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }
        .badge-footer { display: flex; align-items: center; justify-content: space-between; }
        .badge-rarity { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 0.2rem 0.5rem; border-radius: 4px; }
        .badge-rarity.common { background: #e0e0e0; color: #666; }
        .badge-rarity.rare { background: #bbdefb; color: #1565c0; }
        .badge-rarity.epic { background: #e1bee7; color: #7b1fa2; }
        .badge-rarity.legendary { background: linear-gradient(135deg, #ffd700, #ff9800); color: #5d4037; }
        .badge-price { display: flex; align-items: center; gap: 0.35rem; font-weight: 700; color: #ff9800; }
        .buy-btn { background: linear-gradient(135deg, #ffd700, #ff9800); color: #1a1a1a; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }

        /* Coin Packs */
        .coin-packs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .coin-pack { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; text-align: center; transition: all 0.2s; position: relative; }
        .coin-pack:hover { border-color: #ffd700; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,215,0,0.2); }
        .coin-pack.popular { border-color: #ffd700; }
        .coin-pack.popular::before { content: 'BEST VALUE'; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ffd700, #ff9800); color: #000; padding: 0.2rem 0.75rem; border-radius: 10px; font-size: 0.65rem; font-weight: 700; }
        .pack-coins { font-size: 2rem; font-weight: 800; color: #ff9800; margin-bottom: 0.25rem; }
        .pack-name { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
        .pack-bonus { font-size: 0.75rem; color: #4caf50; font-weight: 600; margin-bottom: 0.75rem; }
        .pack-price { font-size: 1.5rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.75rem; }
        .pack-buy-btn { width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #4caf50, #2e7d32); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .pack-buy-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .pack-buy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .buy-btn:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(255,152,0,0.4); }
        .buy-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .buy-btn.owned-btn { background: #4caf50; color: white; cursor: default; }
        .earned-label { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }
        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 1rem 2rem; border-radius: 8px; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        /* Gear & Memorabilia Section */
        .gear-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.25rem; }
        .gear-card { background: var(--card-bg); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden; transition: all 0.2s; cursor: pointer; }
        .gear-card:hover { border-color: var(--accent-color); transform: translateY(-3px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .gear-image { width: 100%; height: 180px; object-fit: contain; background: #f5f5f5; }
        [data-theme="dark"] .gear-image { background: #111; }
        .gear-info { padding: 1rem; }
        .gear-title { font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
        .gear-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .gear-price { font-size: 1.2rem; font-weight: 700; color: #4caf50; }
        .gear-condition { font-size: 0.7rem; padding: 0.2rem 0.4rem; background: var(--dark-bg); border-radius: 4px; color: var(--text-muted); }
        .gear-team { display: inline-block; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 4px; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; }
        .gear-team.eagles { background: #004C54; color: white; }
        .gear-team.phillies { background: #E81828; color: white; }
        .gear-team.sixers { background: #006BB6; color: white; }
        .gear-team.flyers { background: #F74902; color: white; }
        .gear-buy-btn { width: 100%; padding: 0.65rem; background: var(--accent-color); color: white; border: none; border-radius: 6px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; transition: all 0.2s; }
        .gear-buy-btn:hover { opacity: 0.9; }
        .gear-source { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem; text-align: center; }
        .category-tabs { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; flex-wrap: wrap; }
        .category-tab { padding: 0.5rem 1rem; background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; color: var(--text-primary); }
        .category-tab:hover { border-color: var(--accent-color); }
        .category-tab.active { background: var(--accent-color); border-color: var(--accent-color); color: white; }
        .affiliate-disclosure { font-size: 0.75rem; color: var(--text-muted); margin-top: 1rem; padding: 0.75rem; background: var(--dark-bg); border-radius: 8px; }

        .footer { margin-top: 2rem; padding: 1.5rem; background: var(--card-bg); border-top: 1px solid var(--border-color); text-align: center; }
        .footer-copy { color: var(--text-muted); font-size: 0.75rem; }
        @media (max-width: 768px) {
            .page-hero h1 { font-size: 1.75rem; }
            .badge-grid { grid-template-columns: 1fr; }
            .gear-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
            .gear-image { height: 140px; }
            .gear-title { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- Shared Header -->
    <div id="site-header"></div>
    <script src="/js/header.js"></script>

    <section class="page-hero">
        <h1>&#129689; Diehard Dollars Shop</h1>
        <p>Spend your coins on badges to show off your Philly pride!</p>
        <div class="balance-display" id="balanceDisplay">
            <span>&#129689;</span>
            <span id="coinBalance">---</span>
            <span>Diehard Dollars</span>
        </div>
    </section>

    <main class="main-container">
        <!-- Buy Diehard Dollars Section -->
        <div class="shop-section" id="coin-packs">
            <div class="section-header">
                <span class="section-title">Buy Diehard Dollars</span>
            </div>
            <div class="coin-packs-grid" id="coinPacksGrid">
                Loading packs...
            </div>
        </div>

        <!-- Gear & Memorabilia Section -->
        <div class="shop-section" id="gearSection" style="display: none;">
            <div class="section-header">
                <span class="section-title">Gear & Memorabilia</span>
            </div>
            <div class="category-tabs" id="categoryTabs">
                <button class="category-tab active" data-category="all">All</button>
                <button class="category-tab" data-category="apparel">Apparel</button>
                <button class="category-tab" data-category="memorabilia">Memorabilia</button>
                <button class="category-tab" data-category="cards">Cards</button>
                <button class="category-tab" data-category="collectibles">Collectibles</button>
            </div>
            <div class="gear-grid" id="gearGrid">
                Loading gear...
            </div>
            <p class="affiliate-disclosure">
                As an eBay Partner, we may earn from qualifying purchases. Prices and availability subject to change.
            </p>
        </div>

        <!-- Spend Diehard Dollars Section -->
        <div id="shopContent" class="loading">Loading shop...</div>
    </main>

    <div class="toast" id="toast"></div>

    <footer class="footer">
        <p class="footer-copy">&copy; 2025 PhillySports.com. All rights reserved.</p>
    </footer>

    <script>
        // Dark Mode Toggle
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        initTheme();
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) themeToggle.addEventListener('click', toggleTheme);
        });

        let currentBalance = 0;
        let ownedBadges = [];

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }

        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                if (data.user) {
                    currentBalance = data.user.coinBalance || 0;
                    ownedBadges = data.user.badges || [];
                    document.getElementById('coinBalance').textContent = currentBalance.toLocaleString();
                    const premiumBadge = data.user.isSubscribed
                        ? `<a href="/membership.html" class="premium-badge">${data.user.subscriptionTier === 'diehard_pro' ? 'PRO' : '+'}</a>`
                        : `<a href="/membership.html" class="go-premium-link">Go Premium</a>`;
                    const adminLink = data.user.isAdmin
                        ? `<a href="/admin.html" class="admin-link" title="Admin Dashboard">Admin</a>`
                        : '';
                    document.getElementById('headerAuth').innerHTML = `
                        <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                            <span class="theme-icon-light">&#9790;</span>
                            <span class="theme-icon-dark">&#9728;</span>
                        </button>
                        <div class="coin-display" title="Diehard Dollars">
                            <span>&#129689;</span>
                            <span class="coin-balance">${currentBalance}</span>
                            <a href="/shop.html#coin-packs" class="buy-coins-link" title="Buy Diehard Dollars">+</a>
                        </div>
                        ${premiumBadge}
                        ${adminLink}
                        <a href="/profile.html">${data.user.username}</a>
                        <a href="#" id="logoutBtn">Logout</a>
                    `;
                    document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);
                    document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
                        e.preventDefault();
                        await fetch('/api/auth/logout', { method: 'POST' });
                        window.location.href = '/';
                    });
                } else {
                    document.getElementById('coinBalance').textContent = '0';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                document.getElementById('coinBalance').textContent = '0';
            }
        }

        async function loadShop() {
            try {
                const response = await fetch('/api/shop');
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load shop');
                }

                renderShop(data.grouped);
            } catch (error) {
                console.error('Shop load error:', error);
                document.getElementById('shopContent').innerHTML = `<p style="color: red;">Failed to load shop. Please try again.</p>`;
            }
        }

        function renderShop(grouped) {
            const content = document.getElementById('shopContent');

            let html = '';

            // Team Badges
            if (grouped.team && grouped.team.length > 0) {
                html += `
                    <section class="shop-section">
                        <div class="section-header">
                            <h2 class="section-title">Team Fan Badges</h2>
                        </div>
                        <div class="badge-grid">
                            ${grouped.team.map(badge => renderBadgeCard(badge)).join('')}
                        </div>
                    </section>
                `;
            }

            // Premium Badges
            if (grouped.premium && grouped.premium.length > 0) {
                html += `
                    <section class="shop-section">
                        <div class="section-header">
                            <h2 class="section-title">Premium Badges</h2>
                        </div>
                        <div class="badge-grid">
                            ${grouped.premium.map(badge => renderBadgeCard(badge)).join('')}
                        </div>
                    </section>
                `;
            }

            // Legendary Badges
            if (grouped.legendary && grouped.legendary.length > 0) {
                html += `
                    <section class="shop-section">
                        <div class="section-header">
                            <h2 class="section-title">Legendary Badges</h2>
                        </div>
                        <div class="badge-grid">
                            ${grouped.legendary.map(badge => renderBadgeCard(badge)).join('')}
                        </div>
                    </section>
                `;
            }

            // Achievement Badges (earned only)
            if (grouped.achievement && grouped.achievement.length > 0) {
                html += `
                    <section class="shop-section">
                        <div class="section-header">
                            <h2 class="section-title">Achievement Badges (Earned Only)</h2>
                        </div>
                        <div class="badge-grid">
                            ${grouped.achievement.map(badge => renderBadgeCard(badge)).join('')}
                        </div>
                    </section>
                `;
            }

            content.innerHTML = html;
            content.className = '';

            // Add buy button listeners
            document.querySelectorAll('.buy-btn:not(.owned-btn):not(:disabled)').forEach(btn => {
                btn.addEventListener('click', () => purchaseBadge(btn.dataset.badgeId, btn.dataset.badgeName, parseInt(btn.dataset.cost)));
            });
        }

        function renderBadgeCard(badge) {
            const isOwned = ownedBadges.includes(badge._id);
            const isEarnedOnly = badge.cost === 0;
            const canAfford = currentBalance >= badge.cost;

            let cardClass = 'badge-card';
            if (isOwned) cardClass += ' owned';
            if (isEarnedOnly) cardClass += ' earned-only';

            let buttonHtml = '';
            if (isOwned) {
                buttonHtml = `<button class="buy-btn owned-btn">Owned</button>`;
            } else if (isEarnedOnly) {
                buttonHtml = `<span class="earned-label">Earn through achievements</span>`;
            } else {
                buttonHtml = `<button class="buy-btn" data-badge-id="${badge._id}" data-badge-name="${badge.name}" data-cost="${badge.cost}" ${!canAfford ? 'disabled title="Not enough coins"' : ''}>Buy Now</button>`;
            }

            return `
                <div class="${cardClass}">
                    <div class="badge-icon">${badge.icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    <div class="badge-footer">
                        <span class="badge-rarity ${badge.rarity}">${badge.rarity}</span>
                        ${badge.cost > 0 ? `<div class="badge-price"><span>&#129689;</span>${badge.cost}</div>` : ''}
                    </div>
                    <div style="margin-top: 1rem; text-align: center;">
                        ${buttonHtml}
                    </div>
                </div>
            `;
        }

        async function purchaseBadge(badgeId, badgeName, cost) {
            if (!confirm(`Purchase ${badgeName} for ${cost} Diehard Dollars?`)) {
                return;
            }

            try {
                const response = await fetch('/api/shop/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ badgeId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Purchase failed');
                }

                // Update local state
                currentBalance = data.newBalance;
                ownedBadges = data.badges;

                // Update UI
                document.getElementById('coinBalance').textContent = currentBalance.toLocaleString();
                showToast(`Successfully purchased ${badgeName}!`, 'success');

                // Re-render shop to show owned status
                loadShop();
            } catch (error) {
                console.error('Purchase error:', error);
                showToast(error.message, 'error');
            }
        }

        // Load coin packs for purchase
        async function loadCoinPacks() {
            try {
                const response = await fetch('/api/coins/packs');
                const data = await response.json();

                if (!data.packs) {
                    throw new Error('Failed to load packs');
                }

                renderCoinPacks(data.packs);
            } catch (error) {
                console.error('Load packs error:', error);
                document.getElementById('coinPacksGrid').innerHTML = '<p>Failed to load coin packs</p>';
            }
        }

        function renderCoinPacks(packs) {
            const grid = document.getElementById('coinPacksGrid');
            grid.innerHTML = packs.map(pack => `
                <div class="coin-pack ${pack.popular ? 'popular' : ''}">
                    <div class="pack-coins">${pack.coins.toLocaleString()}</div>
                    <div class="pack-name">${pack.name}</div>
                    <div class="pack-bonus">${pack.bonus > 0 ? `+${pack.bonus.toLocaleString()} bonus!` : '&nbsp;'}</div>
                    <div class="pack-price">${pack.priceDisplay}</div>
                    <button class="pack-buy-btn" onclick="purchaseCoinPack('${pack.id}', '${pack.name}', ${pack.coins})">
                        Buy Now
                    </button>
                </div>
            `).join('');
        }

        async function purchaseCoinPack(packId, packName, coins) {
            if (!currentBalance && currentBalance !== 0) {
                window.location.href = '/login.html?redirect=/shop.html';
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Loading...';

                const response = await fetch('/api/coins/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ packId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Purchase failed');
                }

                if (data.checkoutUrl) {
                    window.location.href = data.checkoutUrl;
                } else {
                    throw new Error('No checkout URL returned');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                showToast(error.message, 'error');
                loadCoinPacks(); // Reset buttons
            }
        }

        // ========== GEAR & MEMORABILIA ==========
        let currentCategory = 'all';
        let gearProducts = [];

        async function loadGear() {
            try {
                const params = new URLSearchParams({ limit: 50 });
                if (currentCategory !== 'all') {
                    params.set('category', currentCategory);
                }

                const response = await fetch('/api/shop/products?' + params);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load gear');
                }

                // Filter to only affiliate products
                gearProducts = data.products.filter(p => p.isAffiliate);

                if (gearProducts.length > 0) {
                    document.getElementById('gearSection').style.display = 'block';
                    renderGear();
                } else {
                    document.getElementById('gearSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Load gear error:', error);
                document.getElementById('gearSection').style.display = 'none';
            }
        }

        function renderGear() {
            const grid = document.getElementById('gearGrid');

            let filtered = gearProducts;
            if (currentCategory !== 'all') {
                filtered = gearProducts.filter(p => p.category === currentCategory);
            }

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1; text-align: center; padding: 2rem;">No products in this category yet.</p>';
                return;
            }

            grid.innerHTML = filtered.map(product => {
                const teamClass = product.team ? `gear-team ${product.team}` : '';
                const teamLabel = product.team ? product.team.charAt(0).toUpperCase() + product.team.slice(1) : '';

                return `
                    <div class="gear-card" onclick="openAffiliateLink('${product._id}', '${encodeURIComponent(product.affiliateLink || '')}')">
                        <img src="${product.images?.[0] || '/logo.png'}" alt="${product.name}" class="gear-image" onerror="this.src='/logo.png'" loading="lazy">
                        <div class="gear-info">
                            ${teamLabel ? `<span class="${teamClass}">${teamLabel}</span>` : ''}
                            <h3 class="gear-title">${product.name}</h3>
                            <div class="gear-meta">
                                <span class="gear-price">$${(product.priceUSD || 0).toFixed(2)}</span>
                            </div>
                            <button class="gear-buy-btn">
                                <span>Shop on eBay</span>
                                <span>â†’</span>
                            </button>
                            <p class="gear-source">via eBay Partner</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openAffiliateLink(productId, affiliateLink) {
            try {
                // Track the click
                await fetch('/api/shop/affiliate-click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productId })
                });
            } catch (error) {
                console.error('Failed to track click:', error);
            }

            // Open affiliate link
            if (affiliateLink) {
                window.open(decodeURIComponent(affiliateLink), '_blank');
            }
        }

        // Category tab handlers
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCategory = tab.dataset.category;
                renderGear();
            });
        });

        // Initialize
        checkAuth().then(() => {
            loadCoinPacks();
            loadGear();
            loadShop();
        });
    </script>
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/public/sw.js').catch(err => console.log('SW registration failed:', err));
        }
    </script>
    <!-- Live Ticker -->
    <script src="/js/live-ticker.js"></script>
</body>
</html>
